{% extends 'manager/base.html' %}
{% load static %}
{% block content %}
<div class="content-body">
    <div class="container-fluid">

        <!-- Breadcrumb -->
        <div class="row">
            <div class="col-xl-12">
                <div class="page-titles">
                    <nav style="--bs-breadcrumb-divider: '>';">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="admin-dashboard.html">Dashboard</a></li>
                            <li class="breadcrumb-item active">Send Notifications</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Notification Container -->
        <div class="notification-container">

            <!-- Section 1: Select Recipients -->
            <div class="notification-card">
                <h3 class="section-title">
                    <i class="material-icons">people</i>
                    Select Recipients
                </h3>
                <p class="section-description">Choose who should receive this notification.</p>

                <div class="recipient-options">
                    <label class="recipient-option selected" onclick="selectRecipient('all')">
                        <input type="radio" name="recipient" value="all" checked />
                        <div class="recipient-content">
                            <span class="recipient-label">All Users <span class="recipient-count">1,234</span></span>
                            <span class="recipient-description">Send to every user on the platform</span>
                        </div>
                    </label>

                    <label class="recipient-option" onclick="selectRecipient('kyc-completed')">
                        <input type="radio" name="recipient" value="kyc-completed" />
                        <div class="recipient-content">
                            <span class="recipient-label">KYC Completed <span class="recipient-count">856</span></span>
                            <span class="recipient-description">Users with verified KYC</span>
                        </div>
                    </label>

                    <label class="recipient-option" onclick="selectRecipient('kyc-pending')">
                        <input type="radio" name="recipient" value="kyc-pending" />
                        <div class="recipient-content">
                            <span class="recipient-label">KYC Pending <span class="recipient-count">378</span></span>
                            <span class="recipient-description">Users who haven't completed KYC</span>
                        </div>
                    </label>

                    <label class="recipient-option" onclick="selectRecipient('specific')">
                        <input type="radio" name="recipient" value="specific" />
                        <div class="recipient-content">
                            <span class="recipient-label">Specific User</span>
                            <span class="recipient-description">Choose one user individually</span>
                        </div>
                    </label>
                </div>

                <!-- User Search (hidden by default) -->
                <div class="user-search-container" id="userSearchContainer">
                    <div class="user-search-box">
                        <i class="material-icons search-icon">search</i>
                        <input type="text" class="form-input user-search-input" id="userSearchInput" placeholder="Search by name, email, or ID..." oninput="searchUsers()" />
                    </div>
                    <div class="user-results" id="userResults" style="display: none;">
                        <!-- Search results will appear here -->
                    </div>
                    <div id="selectedUserDisplay"></div>
                </div>
            </div>

            <!-- Section 2: Notification Content -->
            <div class="notification-card">
                <h3 class="section-title">
                    <i class="material-icons">edit_note</i>
                    Notification Content
                </h3>
                <p class="section-description">Compose your notification message.</p>

                <div class="form-group">
                    <label class="form-label">Notification Title <span class="required">*</span></label>
                    <input type="text" class="form-input" id="notificationTitle" placeholder="e.g., Important Platform Update" oninput="updatePreview()" required />
                    <div class="form-help">Keep it short and clear (max 60 characters)</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notification Message <span class="required">*</span></label>
                    <textarea class="form-textarea" id="notificationMessage" placeholder="Enter your message here..." oninput="updatePreview()" required></textarea>
                    <div class="form-help">Provide clear and actionable information for users</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Notification Icon <span class="required">*</span></label>
                        <select class="form-select" id="notificationIcon" onchange="updatePreview()" required>
                            <option value="campaign">Announcement</option>
                            <option value="warning">Warning</option>
                            <option value="info">Information</option>
                            <option value="check_circle">Success</option>
                            <option value="error">Error</option>
                            <option value="notifications">Bell</option>
                            <option value="verified">Verified</option>
                            <option value="security">Security</option>
                            <option value="update">Update</option>
                            <option value="celebration">Celebration</option>
                            <option value="stars">Stars</option>
                            <option value="monetization_on">Money</option>
                        </select>
                        <div class="form-help">Choose an icon that matches your message</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notification Color <span class="required">*</span></label>
                        <select class="form-select" id="notificationColor" onchange="updatePreview()" required>
                            <option value="red">Red (Urgent)</option>
                            <option value="blue">Blue (Information)</option>
                            <option value="green">Green (Success)</option>
                            <option value="yellow">Yellow (Warning)</option>
                            <option value="purple">Purple (Announcement)</option>
                            <option value="orange">Orange (Alert)</option>
                            <option value="gray">Gray (Neutral)</option>
                        </select>
                        <div class="form-help">Select a color that conveys the right tone</div>
                    </div>
                </div>

                <!-- Preview Box -->
                <div class="preview-box">
                    <div class="preview-title">
                        <i class="material-icons">visibility</i>
                        Preview
                    </div>
                    <div class="preview-notification">
                        <div class="preview-notification-header">
                            <div class="preview-icon">
                                <i class="material-icons">campaign</i>
                            </div>
                            <div style="flex: 1;">
                                <div class="preview-notification-title" id="previewTitle">Important Update</div>
                            </div>
                        </div>
                        <p class="preview-notification-message" id="previewMessage">Your notification message will appear here...</p>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button class="btn-cancel" onclick="window.location.href='admin-dashboard.html'">
                    Cancel
                </button>
                <button class="btn-send" onclick="sendNotification()">
                    <i class="material-icons" style="font-size: 18px;">send</i>
                    Send Notification
                </button>
            </div>

        </div>

    </div>
</div>
{% endblock content %}

{% block extra_scripts %}
<script>
    let selectedUser = null;
    let currentRecipient = 'all';

    // Sample user data (in production, this would come from backend)
    const users = [
        { id: 'USR-10245', name: 'John Doe', email: 'johndoe@example.com', initials: 'JD' },
        { id: 'USR-10244', name: 'Sarah Anderson', email: 'sarah@example.com', initials: 'SA' },
        { id: 'USR-10243', name: 'Michael Brown', email: 'michael@example.com', initials: 'MB' },
        { id: 'USR-10242', name: 'Emma Wilson', email: 'emma@example.com', initials: 'EW' },
        { id: 'USR-10241', name: 'Robert Johnson', email: 'robert@example.com', initials: 'RJ' }
    ];

    function selectRecipient(type) {
        currentRecipient = type;

        // Update visual selection
        document.querySelectorAll('.recipient-option').forEach(option => {
            option.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
        event.currentTarget.querySelector('input[type="radio"]').checked = true;

        // Show/hide user search
        const searchContainer = document.getElementById('userSearchContainer');
        if (type === 'specific') {
            searchContainer.classList.add('active');
        } else {
            searchContainer.classList.remove('active');
            selectedUser = null;
            document.getElementById('selectedUserDisplay').innerHTML = '';
            document.getElementById('userResults').style.display = 'none';
        }
    }

    function searchUsers() {
        const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
        const resultsContainer = document.getElementById('userResults');

        if (searchTerm.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        const filteredUsers = users.filter(user =>
            user.name.toLowerCase().includes(searchTerm) ||
            user.email.toLowerCase().includes(searchTerm) ||
            user.id.toLowerCase().includes(searchTerm)
        );

        if (filteredUsers.length === 0) {
            resultsContainer.innerHTML = '<div style="padding: 16px; text-align: center; color: #6b7280;">No users found</div>';
            resultsContainer.style.display = 'block';
            return;
        }

        resultsContainer.innerHTML = filteredUsers.map(user => `
            <div class="user-result-item" onclick="selectUser('${user.id}')">
                <div class="user-result-avatar">${user.initials}</div>
                <div class="user-result-info">
                    <div class="user-result-name">${user.name}</div>
                    <div class="user-result-email">${user.email} â€¢ ${user.id}</div>
                </div>
            </div>
        `).join('');

        resultsContainer.style.display = 'block';
    }

    function selectUser(userId) {
        selectedUser = users.find(u => u.id === userId);

        document.getElementById('selectedUserDisplay').innerHTML = `
            <div class="selected-user-badge">
                <i class="material-icons" style="font-size: 18px;">person</i>
                <strong>${selectedUser.name}</strong> (${selectedUser.email})
                <button class="remove-user-btn" onclick="removeSelectedUser()">
                    <i class="material-icons" style="font-size: 16px;">close</i>
                </button>
            </div>
        `;

        document.getElementById('userSearchInput').value = '';
        document.getElementById('userResults').style.display = 'none';
    }

    function removeSelectedUser() {
        selectedUser = null;
        document.getElementById('selectedUserDisplay').innerHTML = '';
    }

    function updatePreview() {
        const title = document.getElementById('notificationTitle').value || 'Important Update';
        const message = document.getElementById('notificationMessage').value || 'Your notification message will appear here...';
        const icon = document.getElementById('notificationIcon').value || 'campaign';
        const color = document.getElementById('notificationColor').value || 'red';

        // Update preview text
        document.getElementById('previewTitle').textContent = title;
        document.getElementById('previewMessage').textContent = message;

        // Update preview icon
        const previewIconElement = document.querySelector('.preview-icon i');
        previewIconElement.textContent = icon;

        // Update preview color
        const previewIconContainer = document.querySelector('.preview-icon');
        const colorMap = {
            'red': 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
            'blue': 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
            'green': 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
            'yellow': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
            'purple': 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
            'orange': 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)',
            'gray': 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)'
        };
        previewIconContainer.style.background = colorMap[color];
    }

    function sendNotification() {
        const title = document.getElementById('notificationTitle').value;
        const message = document.getElementById('notificationMessage').value;
        const icon = document.getElementById('notificationIcon').value;
        const color = document.getElementById('notificationColor').value;

        if (!title || !message) {
            alert('Please fill in both the title and message fields!');
            return;
        }

        if (currentRecipient === 'specific' && !selectedUser) {
            alert('Please select a user to send the notification to!');
            return;
        }

        // Build recipient description
        let recipientText = '';
        switch(currentRecipient) {
            case 'all':
                recipientText = 'all users (1,234 users)';
                break;
            case 'kyc-completed':
                recipientText = 'all KYC completed users (856 users)';
                break;
            case 'kyc-pending':
                recipientText = 'all KYC pending users (378 users)';
                break;
            case 'specific':
                recipientText = `${selectedUser.name} (${selectedUser.email})`;
                break;
        }

        // Get icon and color labels for display
        const iconLabel = document.querySelector(`#notificationIcon option[value="${icon}"]`).textContent;
        const colorLabel = document.querySelector(`#notificationColor option[value="${color}"]`).textContent;

        if (confirm(`Send notification to ${recipientText}?\n\nTitle: ${title}\nMessage: ${message}\nIcon: ${iconLabel}\nColor: ${colorLabel}`)) {
            // In production, this would send data to backend including icon and color
            const notificationData = {
                recipient: currentRecipient,
                selectedUser: selectedUser,
                title: title,
                message: message,
                icon: icon,
                color: color,
                timestamp: new Date().toISOString()
            };

            console.log('Sending notification:', notificationData);
            alert(`Notification sent successfully to ${recipientText}! (Demo Mode)`);

            // Reset form
            document.getElementById('notificationTitle').value = '';
            document.getElementById('notificationMessage').value = '';
            document.getElementById('notificationIcon').value = 'campaign';
            document.getElementById('notificationColor').value = 'red';
            updatePreview();

            // Redirect after a short delay
            setTimeout(() => {
                window.location.href = 'admin-dashboard.html';
            }, 1000);
        }
    }

    // Mobile Sidebar Toggle
    (function() {
        let overlay = document.querySelector('.sidebar-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'sidebar-overlay';
            document.body.appendChild(overlay);
        }

        const hamburger = document.querySelector('.hamburger');
        const sidebar = document.querySelector('.dlabnav');

        if (hamburger && sidebar) {
            hamburger.addEventListener('click', function(e) {
                e.stopPropagation();
                hamburger.classList.toggle('is-active');
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
                document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
            });

            overlay.addEventListener('click', function() {
                hamburger.classList.remove('is-active');
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            });

            sidebar.querySelectorAll('a').forEach(function(link) {
                link.addEventListener('click', function() {
                    if (window.innerWidth < 768) {
                        setTimeout(function() {
                            hamburger.classList.remove('is-active');
                            sidebar.classList.remove('active');
                            overlay.classList.remove('active');
                            document.body.style.overflow = '';
                        }, 300);
                    }
                });
            });

            window.addEventListener('resize', function() {
                if (window.innerWidth >= 768) {
                    hamburger.classList.remove('is-active');
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        }
    })();
</script>
{% endblock extra_scripts %}