{% extends 'manager/base.html' %}
{% load static %}
{% block content %}
<div class="content-body">
    <div class="container-fluid">

        <!-- Page Header -->
        <div class="page-header">
            <h2>
                <i class="material-icons">payment</i>
                Payment Methods Management
            </h2>
            <p>Configure cryptocurrency and gateway payment methods</p>
        </div>

        <!-- Cryptocurrency Payment Methods -->
        <div class="payment-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="material-icons">currency_bitcoin</i>
                    Cryptocurrency Payment Methods
                </div>
                <button class="btn-add-method" data-bs-toggle="modal" data-bs-target="#cryptoModal">
                    <i class="material-icons">add</i>
                    Add Cryptocurrency
                </button>
            </div>

            <div class="crypto-grid" id="cryptoGrid">
                <!-- TODO: Django will render cryptocurrency payment methods from database -->

                <!-- Bitcoin -->
                {% for currency in currencies %}
                <div class="crypto-card" data-crypto="bitcoin">
                    <div class="crypto-header">
                        <div class="crypto-info">
                            <div class="crypto-name">
                                <strong>{{currency.currency}}</strong>
                                <span>{{currency.network}} Network</span>
                            </div>
                        </div>
                        <form method="POST" action="" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="crypto_id" value="{{currency.ref}}">
                            <label class="toggle-switch">
                                <input type="checkbox" name="switch" value="1" {%if currency.status%}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </form>
                    </div>
                    <div class="crypto-details">
                        <div class="detail-row">
                            <span class="detail-label">Network</span>
                            <span class="detail-value">{{currency.network}}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Transaction Fee</span>
                            <span class="detail-value">${{currency.transaction_fee}}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Min Deposit</span>
                            <span class="detail-value">${{currency.minimum_deposit}}</span>
                        </div>
                    </div>
                    <div class="wallet-address">
                        {{currency.address}}
                        <button class="btn-copy" type="button" onclick="navigator.clipboard.writeText('{{currency.address}}')">
                            <i class="material-icons" style="font-size: 14px;">content_copy</i>
                            Copy
                        </button>
                    </div>
                    <div class="d-flex justify-content-center">
                        <img src="{{currency.qrcode.url}}" alt="QR Code" width="120px">
                    </div>
                    <div class="crypto-actions">
                        <button class="btn-edit" data-bs-toggle="modal" data-bs-target="#cryptoModal{{currency.id}}">
                            <i class="material-icons">edit</i>
                            Edit
                        </button>
                        <button class="btn-delete" data-bs-toggle="modal" data-bs-target="#deleteCryptoModal{{currency.id}}">
                            <i class="material-icons">delete</i>
                        </button>
                    </div>
                </div>

                <div class="modal fade" id="cryptoModal{{currency.id}}" tabindex="-1" aria-labelledby="cryptoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; padding: 20px 24px;">
                                <h5 class="modal-title" id="cryptoModalLabel" style="color: white; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                                    <i class="material-icons" style="font-size: 24px;">currency_bitcoin</i>
                                    Edit Cryptocurrency
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" style="padding: 24px;">
                                <form method="POST" action="">
                                    {% csrf_token %}
                                    <input type="hidden" name="crypto_id" value="{{currency.ref}}">
                
                                    <div class="form-group">
                                        <label class="form-label required">Cryptocurrency Name</label>
                                        <input type="text" class="form-input" name="crypto_name" value="{{currency.currency}}" placeholder="e.g., Bitcoin" required>
                                    </div>
                
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label required">Symbol</label>
                                            <input type="text" class="form-input" name="crypto_symbol" value="{{currency.abbr}}" placeholder="e.g., BTC" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">Network</label>
                                            <input type="text" class="form-input" name="crypto_network" value="{{currency.network}}" placeholder="e.g., Bitcoin (BTC)" required>
                                        </div>
                                    </div>
                
                                    <div class="form-group">
                                        <label class="form-label">Instruction / Memo</label>
                                        <textarea class="form-textarea" name="crypto_memo" placeholder="Enter payment instructions for users (optional)">{{currency.instructions}}</textarea>
                                        <div class="form-help">Special instructions for this wallet address (e.g., "Include your user ID in memo")</div>
                                    </div>
                
                                    <div class="form-group">
                                        <label class="form-label required">Wallet Address</label>
                                        <input type="text" class="form-input" value="{{currency.address}}" name="crypto_address" placeholder="Enter wallet address" required>
                                        <div class="form-help">The cryptocurrency wallet address where deposits will be received. QR code will be auto-generated.</div>
                                    </div>
                
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label required">Transaction Fee ($)</label>
                                            <input type="number" step="0.01" class="form-input" name="crypto_fee" value="{{currency.transaction_fee}}" placeholder="e.g., 2.50" required>
                                            <div class="form-help">Fixed fee in USD</div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label required">Min Deposit ($)</label>
                                            <input type="number" step="0.01" class="form-input" name="crypto_min_deposit" value="{{currency.minimum_deposit}}" placeholder="e.g., 50" required>
                                        </div>
                                    </div>
                
                                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 20px; font-size: 14px; font-weight: 600;">
                                            Cancel
                                        </button>
                                        <button type="submit" name="update" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                            <i class="material-icons" style="font-size: 18px;">save</i>
                                            Save Cryptocurrency
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Delete Cryptocurrency Modal -->
                <div class="modal fade" id="deleteCryptoModal{{currency.id}}" tabindex="-1" aria-labelledby="deleteCryptoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; padding: 20px 24px;">
                                <h5 class="modal-title" id="deleteCryptoModalLabel" style="color: white; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                                    <i class="material-icons" style="font-size: 24px;">warning</i>
                                    Delete Cryptocurrency
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" style="padding: 24px;">
                                <form method="POST" action="">
                                    {% csrf_token %}
                                    <input type="hidden" name="crypto_id" value="{{currency.ref}}">
                
                                    <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                                        <div style="display: flex; align-items: flex-start; gap: 8px;">
                                            <i class="material-icons" style="color: #dc2626; font-size: 18px;">error</i>
                                            <div style="font-size: 13px; color: #7f1d1d; line-height: 1.5;">
                                                <strong>Warning: This action cannot be undone</strong><br>
                                                This will remove all associated settings and users won't be able to deposit using this cryptocurrency method.
                                            </div>
                                        </div>
                                    </div>
                
                                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 20px; font-size: 14px; font-weight: 600;">
                                            Cancel
                                        </button>
                                        <button type="submit" name="delete" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                            <i class="material-icons" style="font-size: 18px;">delete</i>
                                            Delete Cryptocurrency
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

            </div>
        </div>

        <!-- Payment Gateways -->
        <div class="payment-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="material-icons">account_balance</i>
                    Payment Gateways
                </div>
                <button class="btn-add-method" data-bs-toggle="modal" data-bs-target="#gatewayModal">
                    <i class="material-icons">add</i>
                    Add Gateway
                </button>
            </div>

            <table class="gateway-table">
                <thead>
                    <tr>
                        <th>Gateway Name</th>
                        <th>Email</th>
                        <th>Transaction Fee</th>
                        <th>Min Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="gatewayTableBody">
                    <!-- TODO: Django will render payment gateways from database -->
                    {% for gateway in gateways %}
                    <tr>
                        <td>
                            <div class="gateway-name">
                                <div class="gateway-icon">
                                    <i class="material-icons">account_balance</i>
                                </div>
                                {{gateway.name}}
                            </div>
                        </td>
                        <td>{{gateway.email}}</td>
                        <td>${{gateway.transaction_fee}}</td>
                        <td>${{gateway.min_amount}}</td>
                        <td>
                            <form method="POST" action="" style="display: inline;">
                                {% csrf_token %}
                                <input type="hidden" name="gateway_id" value="{{gateway.ref}}">
                                <label class="toggle-switch">
                                    <input type="checkbox" name="gateway_switch" value="1" {% if gateway.status %}checked{% endif %}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </form>
                        </td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-icon edit" data-bs-toggle="modal" data-bs-target="#gatewayModal{{gateway.id}}">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button class="btn-icon delete" data-bs-toggle="modal" data-bs-target="#deleteGatewayModal{{gateway.id}}">
                                    <i class="material-icons">delete</i>
                                </button>
                            </div>
                        </td>
                    </tr>

                    <!-- Edit Gateway Modal -->
                    <div class="modal fade" id="gatewayModal{{gateway.id}}" tabindex="-1" aria-labelledby="gatewayModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; padding: 20px 24px;">
                                    <h5 class="modal-title" id="gatewayModalLabel" style="color: white; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                                        <i class="material-icons" style="font-size: 24px;">account_balance</i>
                                        Edit Payment Gateway
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" style="padding: 24px;">
                                    <form method="POST" action="">
                                        {% csrf_token %}
                                        <input type="hidden" name="gateway_id" value="{{gateway.ref}}">

                                        <div class="form-group">
                                            <label class="form-label required">Gateway Name</label>
                                            <input type="text" class="form-input" name="gateway_name" value="{{gateway.name}}" placeholder="e.g., PayPal" required>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label required">Email / Account ID</label>
                                            <input type="text" class="form-input" name="gateway_email" value="{{gateway.email}}" placeholder="e.g., payments@example.com or $CashTag" required>
                                            <div class="form-help">Email address, username, or account identifier for this gateway</div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label required">Payment Memo / Instructions</label>
                                            <textarea class="form-textarea" name="gateway_memo" placeholder="Enter payment instructions for users..." required>{{gateway.instructions}}</textarea>
                                            <div class="form-help">Instructions that will be shown to users when making a payment</div>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="form-label required">Transaction Fee ($)</label>
                                                <input type="number" step="0.01" class="form-input" name="gateway_fee" value="{{gateway.transaction_fee}}" placeholder="e.g., 0.50" required>
                                                <div class="form-help">Fixed fee in USD</div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label required">Min Amount ($)</label>
                                                <input type="number" step="0.01" class="form-input" name="gateway_min_amount" value="{{gateway.min_amount}}" placeholder="e.g., 10" required>
                                            </div>
                                        </div>

                                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 20px; font-size: 14px; font-weight: 600;">
                                                Cancel
                                            </button>
                                            <button type="submit" name="update_gateway" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                                <i class="material-icons" style="font-size: 18px;">save</i>
                                                Save Gateway
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Gateway Modal -->
                    <div class="modal fade" id="deleteGatewayModal{{gateway.id}}" tabindex="-1" aria-labelledby="deleteGatewayModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; padding: 20px 24px;">
                                    <h5 class="modal-title" id="deleteGatewayModalLabel" style="color: white; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                                        <i class="material-icons" style="font-size: 24px;">warning</i>
                                        Delete Payment Gateway
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" style="padding: 24px;">
                                    <form method="POST" action="">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete_gateway">
                                        <input type="hidden" name="gateway_id" value="{{gateway.ref}}">

                                        <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                                            <div style="display: flex; align-items: flex-start; gap: 8px;">
                                                <i class="material-icons" style="color: #dc2626; font-size: 18px;">error</i>
                                                <div style="font-size: 13px; color: #7f1d1d; line-height: 1.5;">
                                                    <strong>Warning: This action cannot be undone</strong><br>
                                                    This will remove all associated settings and users won't be able to deposit using this payment gateway.
                                                </div>
                                            </div>
                                        </div>

                                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 20px; font-size: 14px; font-weight: 600;">
                                                Cancel
                                            </button>
                                            <button type="submit" name="gateway_delete" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                                <i class="material-icons" style="font-size: 18px;">delete</i>
                                                Delete Gateway
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                </tbody>
            </table>
        </div>

    </div>
</div>

<!-- Add crypo currency -->
<div class="modal fade" id="cryptoModal" tabindex="-1" aria-labelledby="cryptoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border: none; padding: 20px 24px;">
                <h5 class="modal-title" id="cryptoModalLabel" style="color: white; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <i class="material-icons" style="font-size: 24px;">currency_bitcoin</i>
                    Add Cryptocurrency
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form method="POST" action="">
                    <input type="hidden" name="action" value="save_crypto">
                    <input type="hidden" name="crypto_id" value="">

                    <div class="form-group">
                        <label class="form-label required">Cryptocurrency Name</label>
                        <input type="text" class="form-input" name="crypto_name" placeholder="e.g., Bitcoin" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Symbol</label>
                            <input type="text" class="form-input" name="crypto_symbol" placeholder="e.g., BTC" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Network</label>
                            <input type="text" class="form-input" name="crypto_network" placeholder="e.g., Bitcoin (BTC)" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Instruction / Memo</label>
                        <textarea class="form-textarea" name="crypto_memo" placeholder="Enter payment instructions for users (optional)"></textarea>
                        <div class="form-help">Special instructions for this wallet address (e.g., "Include your user ID in memo")</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Wallet Address</label>
                        <input type="text" class="form-input" name="crypto_address" placeholder="Enter wallet address" required>
                        <div class="form-help">The cryptocurrency wallet address where deposits will be received. QR code will be auto-generated.</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Transaction Fee ($)</label>
                            <input type="number" step="0.01" class="form-input" name="crypto_fee" placeholder="e.g., 2.50" required>
                            <div class="form-help">Fixed fee in USD</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Min Deposit ($)</label>
                            <input type="number" step="0.01" class="form-input" name="crypto_min_deposit" placeholder="e.g., 50" required>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 20px; font-size: 14px; font-weight: 600;">
                            Cancel
                        </button>
                        <button type="submit" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="material-icons" style="font-size: 18px;">save</i>
                            Save Cryptocurrency
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add gateway -->
<div class="modal fade" id="gatewayModal" tabindex="-1" aria-labelledby="gatewayModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border: none; padding: 20px 24px;">
                <h5 class="modal-title" id="gatewayModalLabel" style="color: white; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <i class="material-icons" style="font-size: 24px;">account_balance</i>
                    Add Payment Gateway
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <form method="POST" action="">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label class="form-label required">Gateway Name</label>
                        <input type="text" class="form-input" name="gateway_name" placeholder="e.g., PayPal" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Email / Account ID</label>
                        <input type="text" class="form-input" name="gateway_email" placeholder="e.g., payments@example.com or $CashTag" required>
                        <div class="form-help">Email address, username, or account identifier for this gateway</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Payment Memo / Instructions</label>
                        <textarea class="form-textarea" name="gateway_memo" placeholder="Enter payment instructions for users..." required></textarea>
                        <div class="form-help">Instructions that will be shown to users when making a payment</div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Transaction Fee ($)</label>
                            <input type="number" step="0.01" class="form-input" name="gateway_fee" placeholder="e.g., 0.50" required>
                            <div class="form-help">Fixed fee in USD</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Min Amount ($)</label>
                            <input type="number" step="0.01" class="form-input" name="gateway_min_amount" placeholder="e.g., 10" required>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 20px; font-size: 14px; font-weight: 600;">
                            Cancel
                        </button>
                        <button type="submit" name="add_gateway" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 10px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <i class="material-icons" style="font-size: 18px;">save</i>
                            Save Gateway
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}