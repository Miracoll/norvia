{% extends 'manager/base.html' %}
{% load static %}
{% block content %}
<div class="content-body">
    <div class="container-fluid">

        <!-- Breadcrumb -->
        <div class="row">
            <div class="col-xl-12">
                <div class="page-titles">
                    <nav style="--bs-breadcrumb-divider: '>';">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'admin_home' %}">Dashboard</a></li>
                            <li class="breadcrumb-item active">Deposits</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Deposits ({{total_deposits}} Total)</h1>
        </div>

        <!-- Stats Mini Cards -->
        <div class="stats-row">
            <div class="stat-mini">
                <div class="stat-mini-label">Total Deposits (Today)</div>
                <div class="stat-mini-value">${{total_amount_today}}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-mini-label">Pending Approval</div>
                <div class="stat-mini-value" style="color: #f59e0b;">{{pending_count}}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-mini-label">Completed (Today)</div>
                <div class="stat-mini-value" style="color: #10b981;">{{completed_today}}</div>
            </div>
            <div class="stat-mini">
                <div class="stat-mini-label">Failed (Today)</div>
                <div class="stat-mini-value" style="color: #ef4444;">{{failed_today}}</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-card">
            <div class="filters-row">
                <input type="text" class="filter-input" placeholder="Search by user or transaction ID...">
                <select class="filter-select">
                    <option>All Status</option>
                    <option>Pending</option>
                    <option>Completed</option>
                    <option>Failed</option>
                </select>
                <select class="filter-select">
                    <option>All Payment Methods</option>
                    <option>Cryptocurrency</option>
                    <option>PayPal</option>
                    <option>Bank Transfer</option>
                    <option>Zelle</option>
                </select>
                <select class="filter-select">
                    <option>All Dates</option>
                    <option>Today</option>
                    <option>Last 7 days</option>
                    <option>Last 30 days</option>
                </select>
            </div>
            <button class="btn btn-primary">Apply Filters</button>
        </div>

        <!-- Deposits Table -->
        <div class="deposits-table-card">
            <div class="table-responsive">
                <table class="deposits-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>Wallet</th>
                            <th>Status</th>
                            <th>Proof</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for deposit in deposits %}
                        <tr>
                            <td>
                                <div class="user-cell">
                                    <div class="user-avatar">{{deposit.user.first_name|slice:1}}{{deposit.user.last_name|slice:1}}</div>
                                    <div>
                                        <div class="user-name">{{deposit.user.first_name}} {{deposit.user.last_name}}</div>
                                        <div class="user-id">#USR-{{deposit.user.id}}</div>
                                    </div>
                                </div>
                            </td>
                            <td><strong style="color: #10b981;">${{deposit.amount}}</strong></td>
                            <td>
                                {% if deposit.currency %}
                                {{deposit.currency.abbr}} ({{deposit.network}})
                                {% else %}
                                {{deposit.gateway.name}}
                                {% endif %}
                            </td>
                            <td>{{deposit.deposit_to|capfirst}} Wallet</td>
                            <td><span class="status-badge {% if deposit.status == 'pending' %}pending{% elif deposit.status == 'success' %}completed{% else %}failed{% endif %}">{{deposit.status|capfirst}}</span></td>
                            <td>
                                <a href="#" class="proof-link" data-bs-toggle="modal" data-bs-target="#proofModal{{deposit.id}}">
                                    <i class="material-icons" style="font-size: 16px;">receipt</i>
                                    View Proof
                                </a>
                            </td>
                            <td>{{ deposit.date_created|timesince }} ago</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-approve" data-bs-toggle="modal" data-bs-target="#depositModal{{deposit.id}}">
                                        <i class="material-icons" style="font-size: 16px;">check</i>
                                        Approve
                                    </button>
                                    <button class="btn-reject" data-bs-toggle="modal" data-bs-target="#rejectModal{{deposit.id}}">
                                        <i class="material-icons" style="font-size: 16px;">close</i>
                                        Reject
                                    </button>
                                </div>
                            </td>
                        </tr>

                        <div class="modal fade" id="depositModal{{deposit.id}}" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h3 class="modal-title" id="depositModalLabel">
                                            <i class="material-icons">check_circle</i>
                                            Approve Deposit
                                        </h3>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <form method="POST" action="">
                                        {% csrf_token %}
                                        <div class="modal-body">
                                            <!-- Deposit Information -->
                                            <div class="deposit-info-row">
                                                <span class="deposit-info-label">Transaction ID:</span>
                                                <span class="deposit-info-value" id="modalTransactionId">#TXN{{deposit.transaction_no}}</span>
                                            </div>
                                            <div class="deposit-info-row">
                                                <span class="deposit-info-label">User:</span>
                                                <span class="deposit-info-value" id="modalUserName">{{deposit.user.first_name}} {{deposit.user.last_name}}</span>
                                            </div>
                                            <div class="deposit-info-row">
                                                <span class="deposit-info-label">Payment Method:</span>
                                                <span class="deposit-info-value" id="modalPaymentMethod">
                                                    {% if deposit.currency %}
                                                    {{deposit.currency.abbr|upper}} ({{deposit.network}})
                                                    {% else %}
                                                    {{deposit.gateway.name}}
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="deposit-info-row">
                                                <span class="deposit-info-label">Destination Wallet:</span>
                                                <span class="deposit-info-value" id="modalWallet">{{deposit.deposit_to|capfirst}} Wallet</span>
                                            </div>
                                            <div class="deposit-info-row">
                                                <span class="deposit-info-label">Requested Amount:</span>
                                                <span class="deposit-info-value" id="modalRequestedAmount" style="color: #6b7280;">${{deposit.amount}}</span>
                                            </div>
                        
                                            <!-- Hidden inputs for form submission -->
                                            <input type="hidden" name="deposit_id" value="{{deposit.ref}}">
                        
                                            <!-- Amount to Credit -->
                                            <div class="deposit-form-group">
                                                <label class="deposit-form-label">Amount to Credit</label>
                                                <span class="deposit-form-sublabel">Adjust this amount if the received amount differs from the requested amount (e.g., due to transaction fees)</span>
                                                <input type="number" class="deposit-amount-input" id="depositAmountInput" name="credit_amount" value="{{deposit.amount}}">
                                                <!-- Django will calculate and display amount difference if needed -->
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn-deposit-cancel" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn-deposit-confirm" name="approve">
                                                <i class="material-icons">check</i>
                                                Approve & Credit
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reject Deposit Modal - Bootstrap Modal -->
                        <div class="modal fade" id="rejectModal{{deposit.id}}" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h3 class="modal-title" id="rejectModalLabel">
                                            <i class="material-icons">cancel</i>
                                            Reject Deposit
                                        </h3>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <form method="POST" action="">
                                        {% csrf_token %}
                                        <div class="modal-body">
                                            <!-- Deposit Information -->
                                            <div class="deposit-info-row">
                                                <span class="deposit-info-label">Transaction ID:</span>
                                                <span class="deposit-info-value" id="rejectTransactionId">#TXN{{deposit.transaction_no}}</span>
                                            </div>
                                            <div class="deposit-info-row">
                                                <span class="deposit-info-label">User:</span>
                                                <span class="deposit-info-value" id="rejectUserName">{{deposit.user.first_name}} {{deposit.user.last_name}}</span>
                                            </div>
                                            <div class="deposit-info-row">
                                                <span class="deposit-info-label">Payment Method:</span>
                                                <span class="deposit-info-value" id="rejectPaymentMethod">
                                                    {% if deposit.currency %}
                                                    {{deposit.currency}} ({{deposit.network}})
                                                    {% else %}
                                                    {{deposit.gateway.name}}
                                                    {% endif %}
                                                </span>
                                            </div>
                                            <div class="deposit-info-row">
                                                <span class="deposit-info-label">Requested Amount:</span>
                                                <span class="deposit-info-value" id="rejectRequestedAmount" style="color: #6b7280;">${{deposit.amount}}</span>
                                            </div>
                        
                                            <!-- Hidden inputs for form submission -->
                                            <input type="hidden" name="deposit_id" value="{{deposit.ref}}">
                        
                                            <!-- Rejection Reason -->
                                            <div class="deposit-form-group">
                                                <label class="deposit-form-label">Reason for Rejection (Optional)</label>
                                                <span class="deposit-form-sublabel">Provide a reason that will be sent to the user</span>
                                                <textarea class="deposit-reason-input" name="rejection_reason" rows="4" placeholder="e.g., Invalid payment proof, incorrect amount, suspicious transaction..."></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn-deposit-cancel" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn-deposit-reject" name="reject">
                                                <i class="material-icons">cancel</i>
                                                Reject Deposit
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- View Proof Modal - Bootstrap Modal -->
                        <div class="modal fade" id="proofModal{{deposit.id}}" tabindex="-1" aria-labelledby="proofModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h3 class="modal-title" id="proofModalLabel">
                                            <i class="material-icons">receipt</i>
                                            Payment Proof
                                        </h3>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="text-center">
                                            <img id="proofImage" src="{{deposit.image.url}}" alt="Payment Proof" width="120" style="border-radius: 8px;">
                                        </div>
                                        <div class="mt-3">
                                            <p><strong>Transaction ID:</strong> <span id="proofTransactionId">{{deposit.transaction_no}}</span></p>
                                            <p><strong>User:</strong> <span id="proofUserName">{{deposit.user.username}}</span></p>
                                            <p><strong>Amount:</strong> <span id="proofAmount">{{deposit.grand_total}}</span></p>

                                            {% if deposit.transaction_hash %}
                                            <p><strong>Transaction Hash:</strong> <span id="proofAmount">{{deposit.transaction_hash}}</span></p>
                                            {% endif %}
                                            {% if deposit.notes %}
                                            <p><strong>Note:</strong> <span id="proofAmount">{{deposit.notes}}</span></p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

{% endblock %}