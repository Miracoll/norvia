{% extends 'manager/base.html' %}
{% load static %}
{% block content %}
<div class="content-body">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Trader Applications</h1>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card pending">
                <div class="stat-value">{{ stats.pending }}</div>
                <div class="stat-label">Pending Review</div>
            </div>
            <div class="stat-card under-review">
                <div class="stat-value">{{ stats.under_review }}</div>
                <div class="stat-label">Under Review</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-value">{{ stats.approved }}</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card rejected">
                <div class="stat-value">{{ stats.rejected }}</div>
                <div class="stat-label">Rejected</div>
            </div>
        </div>

        <!-- Filters -->
        <form method="GET" action="" class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="">All Status</option>
                        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="under-review" {% if request.GET.status == 'under-review' %}selected{% endif %}>Under Review</option>
                        <option value="approved" {% if request.GET.status == 'approved' %}selected{% endif %}>Approved</option>
                        <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Experience</label>
                    <input type="text" name="experience" value="{{ request.GET.experience }}" placeholder="e.g. 3-5 years">
                </div>
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" name="search" value="{{ request.GET.search }}" placeholder="Search by name or email...">
                </div>
            </div>
            <button type="submit" class="btn-action btn-view" style="margin-top: 12px;">
                <i class="material-icons" style="font-size: 18px;">search</i>
                Apply Filters
            </button>
        </form>

        <!-- Applications Table -->
        <div class="applications-table">
            <div class="table-header">
                <h3 style="margin: 0; font-size: 16px;">Trader Applications</h3>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Applicant</th>
                            <th>Email</th>
                            <th>Experience</th>
                            <th>Trading Volume</th>
                            <th>Applied Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for app in applications %}
                        <tr>
                            <td>
                                <div style="font-weight: 600;">{{ app.full_name }}</div>
                                <div style="font-size: 12px; color: #6b7280;">{{ app.user.username|upper }}</div>
                            </td>
                            <td>{{ app.email }}</td>
                            <td>{{ app.experience }}</td>
                            <td>{{ app.volume }}</td>
                            <td>{{ app.submitted_at|date:"M d, Y" }}</td>
                            <td>
                                <span class="status-badge {{ app.status|lower }}">{{ app.status|title }}</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="#application-{{ app.id }}" class="btn-action btn-view">
                                        <i class="material-icons" style="font-size: 16px;">visibility</i>
                                        View
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" style="text-align:center;">No applications found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Application Modals -->
{% for app in applications %}
<div class="modal" id="application-{{ app.id }}">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Application Details</h3>
            <a href="#" class="modal-close">
                <i class="material-icons">close</i>
            </a>
        </div>
        <div class="modal-body">
            <div class="applicant-info">
                <h4>{{ app.full_name }}</h4>
                <p class="applicant-email">{{ app.email }}</p>
                <p class="applicant-id">{{ app.user.username|upper }}</p>
            </div>

            <div class="detail-row">
                <div class="detail-item">
                    <span class="detail-label">Experience</span>
                    <span class="detail-value">{{ app.experience }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Trading Volume</span>
                    <span class="detail-value">{{ app.volume }}</span>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-item">
                    <span class="detail-label">Applied Date</span>
                    <span class="detail-value">{{ app.submitted_at|date:"M d, Y" }}</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Status</span>
                    <span class="detail-value"><span class="status-badge {{ app.status }}">{{ app.status|title }}</span></span>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-item">
                    <span class="detail-label">Win Rate</span>
                    <span class="detail-value">{{ app.win_rate }}%</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Risk Level</span>
                    <span class="detail-value">{{ app.risk_level }}</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn-modal btn-secondary">Close</a>
            <form method="POST" action="" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="reject_application">
                <input type="hidden" name="application_id" value="{{ app.id }}">
                <button type="submit" class="btn-modal btn-reject">
                    <i class="material-icons" style="font-size:16px;">close</i> Reject
                </button>
            </form>
            <form method="POST" action="" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="approve_application">
                <input type="hidden" name="application_id" value="{{ app.id }}">
                <button type="submit" class="btn-modal btn-approve">
                    <i class="material-icons" style="font-size:16px;">check</i> Approve
                </button>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}
