{% extends 'manager/base.html' %}
{% load static %}
{% block content %}
<div class="content-body">
    <div class="container-fluid">

        <!-- Page Header -->
        <div class="row">
            <div class="col-xl-12">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 style="font-size: 24px; font-weight: 700; color: #1a1a1a; margin: 0;">Email Templates</h2>
                        <p style="color: #64748b; font-size: 14px; margin-top: 4px;">Manage and customize automated email templates</p>
                    </div>
                    <div>
                        <button style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);" onclick="createNewTemplate()">
                            <i class="material-icons">add</i>
                            Create New Template
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Templates Grid -->
        <div class="row">
            <!-- Template 1: Welcome Email -->
            {% for t in templates %}
            <div class="col-xl-6 col-lg-6 col-md-12">
                <div class="card" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px;">
                    <div style="width: 100%; height: 300px; background: #f3f4f6; border-bottom: 2px solid #e5e7eb; position: relative; overflow: hidden;">
                        <iframe src="{% url 'preview-email' t.slug %}" frameborder="0"
                            style="transform: scale(0.5); transform-origin: top left; width: 200%; height: 200%;"></iframe>
                    </div>

                    <div style="padding: 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;">
                            <div>
                                <h4 style="font-size:18px; font-weight:700; margin:0;">{{ t.title }}</h4>
                                <p style="font-size:13px; color:#64748b; margin:0;">{{ t.description }}</p>
                            </div>

                            <span style="padding:6px 12px; border-radius:6px; font-size:12px; background:#d1fae5; color:#065f46;">
                                {{ t.status|title }}
                            </span>
                        </div>

                        <!-- Stats -->
                        <div style="background:#f9fafb; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <i class="material-icons" style="font-size:18px;">schedule</i>
                                <span>Last Updated: {{ t.updated_at|date:"M d, Y" }}</span>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
                                <i class="material-icons" style="font-size:18px;">send</i>
                                <span>Sent: {{ t.sent_count }} times</span>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div style="display:flex; gap:8px; padding-top:16px; border-top:1px solid #e5e7eb;">
                            <a href="{% url 'preview-email' t.slug %}" target="_blank"
                                style="flex:1; padding:8px 12px; border:1px solid #e5e7eb; border-radius:6px;">
                                <i class="material-icons">visibility</i> Preview
                            </a>
                            <button 
                                type="button" 
                                data-bs-toggle="modal" 
                                data-bs-target="#templateEditorModal" 
                                onclick="loadTemplate('{{ t.id }}')"
                                style="flex:1; background:linear-gradient(135deg,#3b82f6,#2563eb); color:white; border:none; border-radius:6px;">
                                <i class="material-icons">edit</i> Edit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

        </div>

    </div>
</div>

<!-- SINGLE MODAL (placed AFTER the for loop) -->
<div class="modal fade" id="templateEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">

            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Edit Email Template</h3>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form method="POST" action="{% url 'save-email-template' %}">
                {% csrf_token %}
                <input type="hidden" name="template_id" id="templateId">

                <div class="modal-body">

                    <!-- TABS -->
                    <div style="display:flex; gap:8px; border-bottom:2px solid #e5e7eb;">
                        <button type="button" id="editTabBtn" onclick="switchTab('edit')"
                            style="border:none; padding:10px; border-bottom:3px solid #ef4444;">
                            Edit
                        </button>
                        <button type="button" id="previewTabBtn" onclick="switchTab('preview')"
                            style="border:none; padding:10px; border-bottom:3px solid transparent;">
                            Preview
                        </button>
                    </div>

                    <!-- EDIT TAB -->
                    <div id="editTab">
                        <label>Template Name</label>
                        <input type="text" name="name" id="templateName" class="form-control">

                        <label>Subject</label>
                        <input type="text" name="subject" id="templateSubject" class="form-control">

                        <label>Description</label>
                        <input type="text" name="description" id="templateDescription" class="form-control">

                        <label>Email Body</label>
                        <textarea name="body" id="templateBody" class="form-control" rows="6"></textarea>

                        <label>Status</label>
                        <select name="status" id="templateStatus" class="form-control">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="draft">Draft</option>
                        </select>
                    </div>

                    <!-- PREVIEW TAB -->
                    <div id="previewTab" style="display:none;">
                        <iframe id="templatePreviewIframe" style="width:100%; height:500px; border:1px solid #ddd;"></iframe>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Save</button>
                </div>

            </form>
        </div>
    </div>
</div>

{% endblock %}
{% block extra_script %}
<script>
    function loadTemplate(id) {
        fetch(`/email-template/${id}/json/`)
            .then(response => response.json())
            .then(data => {
                // Fill modal fields
                document.getElementById('templateId').value = data.id;
                document.getElementById('templateName').value = data.title;
                document.getElementById('templateDescription').value = data.description;
                document.getElementById('templateSubject').value = data.subject || "";
                document.getElementById('templateBody').value = data.body_content || "";
                document.getElementById('templateStatus').value = data.status;
    
                // Update preview iframe
                document.getElementById('templatePreviewIframe').src = `/preview-email/${data.slug}/`;
    
                // Update modal title
                document.getElementById('modalTitle').innerText = "Edit: " + data.title;
            });
    }
    
    function switchTab(tab) {
        document.getElementById("editTab").style.display = tab === "edit" ? "block" : "none";
        document.getElementById("previewTab").style.display = tab === "preview" ? "block" : "none";
    
        document.getElementById("editTabBtn").style.borderBottom =
            tab === "edit" ? "3px solid #ef4444" : "3px solid transparent";
    
        document.getElementById("previewTabBtn").style.borderBottom =
            tab === "preview" ? "3px solid #ef4444" : "3px solid transparent";
    }
    </script>
    
{% endblock %}