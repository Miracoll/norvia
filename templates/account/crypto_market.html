{% extends "account/base.html" %}
{% load static %}

{% block title %}Crypto Market{% endblock %}

{% block body_class %}page-cryptomarket{% endblock %}

{% block page_scripts %}
<script>
// Live Chart Variables
		let cryptoData = [];
		let currentCrypto = null;
		let currentPrice = 0;
		let priceChart = null;
		let currentTimeframe = 0.003472; // Default to 5 minutes
		let fetchAttempts = 0;
		const MAX_FETCH_ATTEMPTS = 3;

		// Fetch Crypto List with retry logic
		async function fetchCryptoList() {
			try {
				fetchAttempts++;
				const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h');

				if (!response.ok) {
					throw new Error(`HTTP ${response.status}`);
				}

				cryptoData = await response.json();
				fetchAttempts = 0; // Reset on success
				populateDropdown();

				if (cryptoData.length > 0) {
					loadCryptoData(cryptoData[0].id);
				}

				clearError();
			} catch (error) {
				console.error('Error fetching crypto list:', error);

				if (fetchAttempts < MAX_FETCH_ATTEMPTS) {
					// Retry after delay
					setTimeout(() => {
						fetchCryptoList();
					}, 2000 * fetchAttempts); // Exponential backoff
				} else {
					showError('Unable to load cryptocurrency data. This may be due to API rate limiting. Please wait a moment and try again.');
				}
			}
		}

		function populateDropdown() {
			const dropdown = document.getElementById('cryptoDropdown');
			dropdown.innerHTML = cryptoData.map(crypto =>
				`<option value="${crypto.id}" data-logo="${crypto.image}">${crypto.name} (${crypto.symbol.toUpperCase()}) - $${crypto.current_price.toLocaleString()}</option>`
			).join('');

			dropdown.addEventListener('change', function() {
				const selectedCrypto = cryptoData.find(c => c.id === this.value);
				if (selectedCrypto) {
					document.getElementById('selectedLogo').src = selectedCrypto.image;
					loadCryptoData(this.value);
				}
			});

			// Set first crypto as selected
			if (cryptoData.length > 0) {
				document.getElementById('selectedLogo').src = cryptoData[0].image;
			}
		}

		async function loadCryptoData(coinId) {
			try {
				const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}`);

				if (!response.ok) {
					throw new Error(`HTTP ${response.status}`);
				}

				const data = await response.json();
				currentCrypto = data;
				currentPrice = data.market_data.current_price.usd;

				document.getElementById('currentPrice').textContent = '$' + currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
				document.getElementById('marketCap').textContent = '$' + (data.market_data.market_cap.usd / 1e9).toFixed(2) + 'B';
				document.getElementById('volume24h').textContent = '$' + (data.market_data.total_volume.usd / 1e9).toFixed(2) + 'B';

				const change24h = data.market_data.price_change_percentage_24h;
				const change24hElement = document.getElementById('change24h');
				change24hElement.textContent = (change24h >= 0 ? '+' : '') + change24h.toFixed(2) + '%';
				change24hElement.style.color = change24h >= 0 ? '#10b981' : '#ef4444';

				loadChart(coinId, currentTimeframe);
			} catch (error) {
				console.error('Error loading crypto data:', error);
				showError('Error loading cryptocurrency details. Please select another asset or refresh the page.');
			}
		}

		async function loadChart(coinId, days) {
			try {
				document.getElementById('chartLoading').style.display = 'block';

				const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=${days}`);

				if (!response.ok) {
					throw new Error(`HTTP ${response.status}`);
				}

				const data = await response.json();

				const prices = data.prices.map(p => ({
					x: new Date(p[0]),
					y: p[1]
				}));

				if (priceChart) {
					priceChart.destroy();
				}

				const ctx = document.getElementById('priceChart').getContext('2d');
				priceChart = new Chart(ctx, {
					type: 'line',
					data: {
						datasets: [{
							label: 'Price',
							data: prices,
							borderColor: '#01A3FF',
							backgroundColor: 'rgba(102, 126, 234, 0.1)',
							borderWidth: 2,
							fill: true,
							tension: 0.4,
							pointRadius: 0,
							pointHoverRadius: 6,
							pointHoverBackgroundColor: '#01A3FF',
							pointHoverBorderColor: 'white',
							pointHoverBorderWidth: 2
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						interaction: {
							mode: 'index',
							intersect: false
						},
						plugins: {
							legend: {
								display: false
							},
							tooltip: {
								backgroundColor: 'rgba(0, 0, 0, 0.8)',
								padding: 12,
								titleFont: {
									size: 14
								},
								bodyFont: {
									size: 13
								},
								callbacks: {
									label: function(context) {
										return 'Price: $' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
									}
								}
							}
						},
						scales: {
							x: {
								type: 'time',
								time: {
									unit: days === 1 ? 'hour' : 'day',
									displayFormats: {
										hour: 'HH:mm',
										day: 'MMM dd'
									}
								},
								grid: {
									display: false
								},
								ticks: {
									font: {
										size: 11
									},
									color: '#6b7280'
								}
							},
							y: {
								grid: {
									color: '#f3f4f6'
								},
								ticks: {
									font: {
										size: 11
									},
									color: '#6b7280',
									callback: function(value) {
										return '$' + value.toLocaleString();
									}
								}
							}
						}
					}
				});

				document.getElementById('chartLoading').style.display = 'none';
			} catch (error) {
				console.error('Error loading chart:', error);
				document.getElementById('chartLoading').style.display = 'none';
			}
		}

		function changeTimeframe(days) {
			currentTimeframe = days;
			document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
			event.target.classList.add('active');

			if (currentCrypto) {
				loadChart(currentCrypto.id, days);
			}
		}

		function showError(message) {
			const errorContainer = document.getElementById('errorContainer');
			errorContainer.innerHTML = `
				<div class="error-message">
					<i class="material-icons">error_outline</i>
					<div class="error-message-text">
						<strong>Connection Error</strong>
						${message}
					</div>
					<button class="retry-btn" onclick="retryFetch()">
						<i class="material-icons" style="font-size: 16px; vertical-align: middle;">refresh</i>
						Retry
					</button>
				</div>
			`;
		}

		function clearError() {
			document.getElementById('errorContainer').innerHTML = '';
		}

		function retryFetch() {
			fetchAttempts = 0;
			clearError();
			fetchCryptoList();
		}

		// UI-only: Toggle active class for button selections (Django handles actual values)
		document.addEventListener('DOMContentLoaded', function() {
			// Mode selection (Spot/Leverage) - Visual feedback only
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('mode-btn')) {
					const form = e.target.closest('.trading-form');
					form.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
					e.target.classList.add('active');

					// Show/hide leverage options for visual feedback
					const leverageOptions = form.querySelector('.leverage-options');
					if (e.target.getAttribute('data-mode') === 'leverage') {
						leverageOptions.classList.add('show');
					} else {
						leverageOptions.classList.remove('show');
					}
				}
			});

			// Leverage selection - Visual feedback only
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('leverage-btn')) {
					const form = e.target.closest('.trading-form');
					form.querySelectorAll('.leverage-btn').forEach(btn => btn.classList.remove('active'));
					e.target.classList.add('active');
				}
			});

			// Duration selection - Visual feedback only
			document.addEventListener('click', function(e) {
				if (e.target.classList.contains('duration-btn')) {
					const form = e.target.closest('.trading-form');
					form.querySelectorAll('.duration-btn').forEach(btn => btn.classList.remove('active'));
					e.target.classList.add('active');
				}
			});
		});

		// Initialize
		fetchCryptoList();

		// Refresh data every 60 seconds (reduced frequency to avoid rate limiting)
		setInterval(() => {
			if (cryptoData.length > 0 && currentCrypto && fetchAttempts === 0) {
				fetchCryptoList();
			}
		}, 60000);

		// Update footer year
		document.querySelector('.current-year').textContent = new Date().getFullYear();
</script>
{% endblock %}

{% block content %}
<div class="content-body">
			<div class="container-fluid">
				<!-- Breadcrumb -->
				<div class="page-titles">
					<ol class="breadcrumb">
						<li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
						<li class="breadcrumb-item"><a href="javascript:void(0)">Market</a></li>
						<li class="breadcrumb-item active">Cryptocurrency</li>
					</ol>
				</div>

				<!-- Chart Panel - Full Width -->
				<div class="chart-panel">
					<div class="chart-header">
						<div class="crypto-selector-wrapper">
							<div class="crypto-selector">
								<img id="selectedLogo" class="selected-crypto-logo" src="" alt="">
								<select id="cryptoDropdown" class="crypto-dropdown">
									<option value="">Loading cryptocurrencies...</option>
								</select>
							</div>
						</div>

						<div class="timeframe-selector">
							<button class="timeframe-btn active" onclick="changeTimeframe(0.003472)">5m</button>
							<button class="timeframe-btn" onclick="changeTimeframe(0.010417)">15m</button>
							<button class="timeframe-btn" onclick="changeTimeframe(0.020833)">30m</button>
							<button class="timeframe-btn" onclick="changeTimeframe(0.041667)">1h</button>
							<button class="timeframe-btn" onclick="changeTimeframe(0.166667)">4h</button>
						</div>
					</div>

					<div class="price-stats">
						<div class="stat-item">
							<div class="stat-label">Current Price</div>
							<div class="stat-value" id="currentPrice">$0.00</div>
						</div>
						<div class="stat-item">
							<div class="stat-label">24h Change</div>
							<div class="stat-value" id="change24h">0.00%</div>
						</div>
						<div class="stat-item">
							<div class="stat-label">Market Cap</div>
							<div class="stat-value" id="marketCap">$0.00</div>
						</div>
						<div class="stat-item">
							<div class="stat-label">24h Volume</div>
							<div class="stat-value" id="volume24h">$0.00</div>
						</div>
					</div>

					<div class="chart-container">
						<div class="chart-wrapper">
							<canvas id="priceChart"></canvas>
						</div>
						<div class="loading" id="chartLoading" style="display: none;">Loading chart...</div>
					</div>

					<div id="errorContainer"></div>
				</div>

				<!-- Trading Section -->
				<div class="trading-section">
					<div class="trading-header">
						<h3>Live Trading</h3>
					</div>

					<div class="copy-advisory">
						<i class="material-icons">lightbulb</i>
						<div class="copy-advisory-text">
							<strong>Pro Tip!</strong>
							Consider copying expert traders instead of manual trading.
						</div>
						<a href="{% url 'copy_trader' %}" class="copy-advisory-link">Browse Experts</a>
					</div>

					<ul class="nav trading-tabs" role="tablist" style="margin-top: 20px; display: flex; justify-content: space-between;">
						<li class="nav-item" role="presentation" style="flex: 1;">
							<button class="nav-link tab-btn buy active" data-bs-toggle="tab" data-bs-target="#buyForm" type="button" role="tab" style="width: 100%;">
								<i class="material-icons">trending_up</i>
								BUY
							</button>
						</li>
						<li class="nav-item" role="presentation" style="flex: 1;">
							<button class="nav-link tab-btn sell" data-bs-toggle="tab" data-bs-target="#sellForm" type="button" role="tab" style="width: 100%;">
								<i class="material-icons">trending_down</i>
								SELL
							</button>
						</li>
					</ul>

					<div class="tab-content">
						<!-- Buy Form -->
						<div class="trading-form tab-pane fade show active" id="buyForm" role="tabpanel">
						<div class="form-row">
							<div class="form-group">
								<label class="form-label">Trading Mode</label>
								<div class="leverage-mode">
									<button class="mode-btn active" data-mode="spot">Spot Trading</button>
									<button class="mode-btn" data-mode="leverage">Leverage</button>
								</div>
								<div class="leverage-options" id="buyLeverageOptions">
									<button class="leverage-btn active" data-leverage="10">10X</button>
									<button class="leverage-btn" data-leverage="25">25X</button>
									<button class="leverage-btn" data-leverage="50">50X</button>
									<button class="leverage-btn" data-leverage="100">100X</button>
									<button class="leverage-btn" data-leverage="200">200X</button>
									<button class="leverage-btn" data-leverage="500">500X</button>
								</div>
							</div>

							<div class="form-group">
								<label class="form-label">Duration (Minutes)</label>
								<div class="duration-buttons">
									<button class="duration-btn active" data-seconds="60">1</button>
									<button class="duration-btn" data-seconds="180">3</button>
									<button class="duration-btn" data-seconds="300">5</button>
									<button class="duration-btn" data-seconds="900">15</button>
									<button class="duration-btn" data-seconds="1800">30</button>
								</div>
							</div>
						</div>

						<div class="form-row">
							<div class="form-group">
								<label class="form-label">Investment Amount (USD)</label>
								<input type="number" class="form-input" id="buyAmount" placeholder="Minimum $10" min="10" step="1">
							</div>

							<div class="form-group">
								<label class="form-label">&nbsp;</label>
								<button class="trade-btn buy" >
									<i class="material-icons">rocket_launch</i>
									Open Buy Position
								</button>
							</div>
						</div>
						</div>

						<!-- Sell Form -->
						<div class="trading-form tab-pane fade" id="sellForm" role="tabpanel">
						<div class="form-row">
							<div class="form-group">
								<label class="form-label">Trading Mode</label>
								<div class="leverage-mode">
									<button class="mode-btn active" data-mode="spot">Spot Trading</button>
									<button class="mode-btn" data-mode="leverage">Leverage</button>
								</div>
								<div class="leverage-options" id="sellLeverageOptions">
									<button class="leverage-btn active" data-leverage="10">10X</button>
									<button class="leverage-btn" data-leverage="25">25X</button>
									<button class="leverage-btn" data-leverage="50">50X</button>
									<button class="leverage-btn" data-leverage="100">100X</button>
									<button class="leverage-btn" data-leverage="200">200X</button>
									<button class="leverage-btn" data-leverage="500">500X</button>
								</div>
							</div>

							<div class="form-group">
								<label class="form-label">Duration (Minutes)</label>
								<div class="duration-buttons">
									<button class="duration-btn active" data-seconds="60">1</button>
									<button class="duration-btn" data-seconds="180">3</button>
									<button class="duration-btn" data-seconds="300">5</button>
									<button class="duration-btn" data-seconds="900">15</button>
									<button class="duration-btn" data-seconds="1800">30</button>
								</div>
							</div>
						</div>

						<div class="form-row">
							<div class="form-group">
								<label class="form-label">Investment Amount (USD)</label>
								<input type="number" class="form-input" id="sellAmount" placeholder="Minimum $10" min="10" step="1">
							</div>

							<div class="form-group">
								<label class="form-label">&nbsp;</label>
								<button class="trade-btn sell" >
									<i class="material-icons">rocket_launch</i>
									Open Sell Position
								</button>
							</div>
						</div>
						</div>
					</div>
				</div>

				<!-- Active Trades Section -->
				<div class="trades-section">
					<div class="trades-header">
						<h3>My Trades</h3>
					</div>

					<ul class="nav nav-tabs trade-tabs" role="tablist">
						<li class="nav-item" role="presentation">
							<button class="nav-link trade-tab active" id="open-tab" data-bs-toggle="tab" data-bs-target="#openTrades" type="button" role="tab">Open Trades</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link trade-tab" id="closed-tab" data-bs-toggle="tab" data-bs-target="#closedTrades" type="button" role="tab">Closed Trades</button>
						</li>
					</ul>

					<div class="tab-content">
						<div class="trades-list tab-pane fade show active" id="openTrades" role="tabpanel">
							<!-- Django: {% for trade in open_trades %} -->

							<!-- Open Trade 1 - Profit -->
							<div class="trade-card profit">
								<div class="trade-header">
									<div class="trade-pair">BTC/USDT</div>
									<div class="trade-status active">Active</div>
								</div>
								<div class="trade-info">
									<span>Entry: $64,250</span>
									<span>Current: $65,120</span>
								</div>
								<div class="trade-info">
									<span>Type: Long (Spot)</span>
									<span>Size: 0.05 BTC</span>
								</div>
								<div class="trade-pnl profit">+$43.50 (+1.35%)</div>
							</div>

							<!-- Open Trade 2 - Loss -->
							<div class="trade-card loss">
								<div class="trade-header">
									<div class="trade-pair">ETH/USDT</div>
									<div class="trade-status active">Active</div>
								</div>
								<div class="trade-info">
									<span>Entry: $3,420</span>
									<span>Current: $3,385</span>
								</div>
								<div class="trade-info">
									<span>Type: Short (10X)</span>
									<span>Size: 0.8 ETH</span>
								</div>
								<div class="trade-pnl loss">-$28.00 (-1.02%)</div>
							</div>

							<!-- Django: {% empty %} -->
							<!-- <div class="empty-trades">
								<i class="material-icons">inbox</i>
								<p>No open trades yet. Start trading above!</p>
							</div> -->
							<!-- Django: {% endfor %} -->
						</div>

						<div class="trades-list tab-pane fade" id="closedTrades" role="tabpanel">
							<!-- Django: {% for trade in closed_trades %} -->

							<!-- Closed Trade 1 - Profit -->
							<div class="trade-card profit">
								<div class="trade-header">
									<div class="trade-pair">SOL/USDT</div>
									<div class="trade-status">Closed</div>
								</div>
								<div class="trade-info">
									<span>Entry: $142.30</span>
									<span>Exit: $145.80</span>
								</div>
								<div class="trade-info">
									<span>Type: Long (Spot)</span>
									<span>Closed: 2 hours ago</span>
								</div>
								<div class="trade-pnl profit">+$87.50 (+2.46%)</div>
							</div>

							<!-- Closed Trade 2 - Profit -->
							<div class="trade-card profit">
								<div class="trade-header">
									<div class="trade-pair">ADA/USDT</div>
									<div class="trade-status">Closed</div>
								</div>
								<div class="trade-info">
									<span>Entry: $0.58</span>
									<span>Exit: $0.61</span>
								</div>
								<div class="trade-info">
									<span>Type: Long (25X)</span>
									<span>Closed: 5 hours ago</span>
								</div>
								<div class="trade-pnl profit">+$120.00 (+5.17%)</div>
							</div>

							<!-- Closed Trade 3 - Loss -->
							<div class="trade-card loss">
								<div class="trade-header">
									<div class="trade-pair">XRP/USDT</div>
									<div class="trade-status">Closed</div>
								</div>
								<div class="trade-info">
									<span>Entry: $0.52</span>
									<span>Exit: $0.50</span>
								</div>
								<div class="trade-info">
									<span>Type: Long (Spot)</span>
									<span>Closed: 1 day ago</span>
								</div>
								<div class="trade-pnl loss">-$40.00 (-3.85%)</div>
							</div>

							<!-- Django: {% empty %} -->
							<!-- <div class="empty-trades">
								<i class="material-icons">history</i>
								<p>No closed trades yet.</p>
							</div> -->
							<!-- Django: {% endfor %} -->
						</div>
					</div>
				</div>
			</div>
		</div>
{% endblock %}
