{% extends "account/base.html" %}
{% load static %}

{% block title %}Crypto Market{% endblock %}

{% block body_class %}page-cryptomarket{% endblock %}

{% block page_scripts %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
	// ----------------------------
	// Live Chart & Market Script
	// ----------------------------
	let cryptoData = [];
	let currentCrypto = null;
	let currentPrice = 0;
	let priceChart = null;
	let currentTimeframe = 0.003472; // Default to 5 minutes (CoinGecko days param approximation)
	let fetchAttempts = 0;
	const MAX_FETCH_ATTEMPTS = 3;

	// Fetch Crypto List (CoinGecko) with retry logic
	async function fetchCryptoList() {
		try {
			fetchAttempts++;
			const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h');

			if (!response.ok) {
				throw new Error(`HTTP ${response.status}`);
			}

			cryptoData = await response.json();
			fetchAttempts = 0; // Reset on success
			populateDropdown();

			if (cryptoData.length > 0) {
				loadCryptoData(cryptoData[0].id);
			}

			clearError();
		} catch (error) {
			console.error('Error fetching crypto list:', error);

			if (fetchAttempts < MAX_FETCH_ATTEMPTS) {
				// Retry after delay (exponential backoff)
				setTimeout(() => {
					fetchCryptoList();
				}, 2000 * fetchAttempts);
			} else {
				showError('Unable to load cryptocurrency data. This may be due to API rate limiting. Please wait a moment and try again.');
			}
		}
	}

	function populateDropdown() {
		const dropdown = document.getElementById('cryptoDropdown');
		if (!dropdown) return;

		dropdown.innerHTML = cryptoData.map(crypto =>
			`<option value="${crypto.id}" data-logo="${crypto.image}">${crypto.name} (${crypto.symbol.toUpperCase()}) - $${crypto.current_price.toLocaleString()}</option>`
		).join('');

		dropdown.addEventListener('change', function () {
			const selectedCrypto = cryptoData.find(c => c.id === this.value);
			if (selectedCrypto) {
				const logoEl = document.getElementById('selectedLogo');
				if (logoEl) logoEl.src = selectedCrypto.image;
				loadCryptoData(this.value);
			}
		});

		// Set first crypto as selected image
		if (cryptoData.length > 0) {
			const logoEl = document.getElementById('selectedLogo');
			if (logoEl) logoEl.src = cryptoData[0].image;
			// ensure select shows first option as selected
			dropdown.value = cryptoData[0].id;
		}
	}

	// Load details for a single coin
	async function loadCryptoData(coinId) {
		try {
			const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}`);

			if (!response.ok) {
				throw new Error(`HTTP ${response.status}`);
			}

			const data = await response.json();
			currentCrypto = data;
			currentPrice = data.market_data.current_price.usd;

			// Update UI stats
			const priceEl = document.getElementById('currentPrice');
			const mcEl = document.getElementById('marketCap');
			const volEl = document.getElementById('volume24h');
			const change24hElement = document.getElementById('change24h');

			if (priceEl) priceEl.textContent = '$' + currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
			if (mcEl) mcEl.textContent = '$' + (data.market_data.market_cap.usd / 1e9).toFixed(2) + 'B';
			if (volEl) volEl.textContent = '$' + (data.market_data.total_volume.usd / 1e9).toFixed(2) + 'B';

			const change24h = data.market_data.price_change_percentage_24h || 0;
			if (change24hElement) {
				change24hElement.textContent = (change24h >= 0 ? '+' : '') + change24h.toFixed(2) + '%';
				change24hElement.style.color = change24h >= 0 ? '#10b981' : '#ef4444';
			}

			// Load chart with the current timeframe param
			loadChart(coinId, currentTimeframe);
		} catch (error) {
			console.error('Error loading crypto data:', error);
			showError('Error loading cryptocurrency details. Please select another asset or refresh the page.');
		}
	}

	// Convert our 'days' approximation to a value coinGecko market_chart endpoint will accept.
	function timeframeToDays(daysParam) {
		return daysParam;
	}

	// Load Chart (uses coin market_chart)
	async function loadChart(coinId, days) {
		try {
			const chartLoading = document.getElementById('chartLoading');
			if (chartLoading) chartLoading.style.display = 'block';

			const daysValue = timeframeToDays(days);

			const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=${daysValue}`);

			if (!response.ok) {
				throw new Error(`HTTP ${response.status}`);
			}

			const data = await response.json();

			const prices = data.prices.map(p => ({
				x: new Date(p[0]),
				y: p[1]
			}));

			// Destroy previous chart
			if (priceChart) {
				try { priceChart.destroy(); } catch (err) { /* ignore */ }
			}

			const ctx = document.getElementById('priceChart').getContext('2d');
			priceChart = new Chart(ctx, {
				type: 'line',
				data: {
					datasets: [{
						label: 'Price',
						data: prices,
						borderColor: '#01A3FF',
						backgroundColor: 'rgba(102, 126, 234, 0.1)',
						borderWidth: 2,
						fill: true,
						tension: 0.4,
						pointRadius: 0,
						pointHoverRadius: 6,
						pointHoverBackgroundColor: '#01A3FF',
						pointHoverBorderColor: 'white',
						pointHoverBorderWidth: 2,
						parsing: {
							xAxisKey: 'x',
							yAxisKey: 'y'
						}
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					interaction: { mode: 'index', intersect: false },
					plugins: {
						legend: { display: false },
						tooltip: {
							backgroundColor: 'rgba(0, 0, 0, 0.8)',
							padding: 12,
							titleFont: { size: 14 },
							bodyFont: { size: 13 },
							callbacks: {
								label: function (context) {
									const val = context.parsed.y;
									return 'Price: $' + (typeof val === 'number' ? val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : val);
								}
							}
						}
					},
					scales: {
						x: {
							type: 'time',
							time: {
								unit: daysValue <= 0.02 ? 'hour' : 'day',
								displayFormats: { hour: 'HH:mm', day: 'MMM dd' }
							},
							grid: { display: false },
							ticks: { font: { size: 11 }, color: '#6b7280' }
						},
						y: {
							grid: { color: '#f3f4f6' },
							ticks: {
								font: { size: 11 },
								color: '#6b7280',
								callback: function (value) { return '$' + Number(value).toLocaleString(); }
							}
						}
					}
				}
			});

			if (chartLoading) chartLoading.style.display = 'none';
		} catch (error) {
			console.error('Error loading chart:', error);
			const chartLoading = document.getElementById('chartLoading');
			if (chartLoading) chartLoading.style.display = 'none';
		}
	}

	// called from timeframe button clicks; using event param to detect which button was clicked
	function changeTimeframe(days, event) {
		currentTimeframe = days;

		// Remove / add active classes
		document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
		if (event && event.currentTarget) {
			event.currentTarget.classList.add('active');
		} else if (event && event.target) {
			event.target.classList.add('active');
		}

		if (currentCrypto) {
			loadChart(currentCrypto.id, days);
		}
	}

	// Error UI helpers
	function showError(message) {
		const errorContainer = document.getElementById('errorContainer');
		if (!errorContainer) return;
		errorContainer.innerHTML = `
			<div class="error-message">
				<i class="material-icons">error_outline</i>
				<div class="error-message-text">
					<strong>Connection Error</strong>
					${message}
				</div>
				<button class="retry-btn" id="retryBtn">
					<i class="material-icons" style="font-size: 16px; vertical-align: middle;">refresh</i>
					Retry
				</button>
			</div>
		`;
		const retryBtn = document.getElementById('retryBtn');
		if (retryBtn) retryBtn.addEventListener('click', retryFetch);
	}

	function clearError() {
		const errorContainer = document.getElementById('errorContainer');
		if (errorContainer) errorContainer.innerHTML = '';
	}

	function retryFetch() {
		fetchAttempts = 0;
		clearError();
		fetchCryptoList();
	}

	// ----------------------------
	// AJAX: Submit Trade Data to Django
	// ----------------------------
	// Helper: get CSRF token from cookies
	function getCSRFToken() {
		const name = 'csrftoken';
		const cookies = document.cookie ? document.cookie.split(';') : [];
		for (let cookie of cookies) {
			cookie = cookie.trim();
			if (cookie.startsWith(name + '=')) {
				return decodeURIComponent(cookie.substring(name.length + 1));
			}
		}
		return '';
	}

	// Attach click handlers to Buy/Sell buttons (delegation)
	document.addEventListener('DOMContentLoaded', function () {
		// Wire timeframe-buttons to call changeTimeframe with the event so we can set active class
		document.querySelectorAll('.timeframe-btn').forEach(btn => {
			btn.addEventListener('click', function (e) {
				const attr = this.getAttribute('onclick');
				let daysVal = currentTimeframe;
				if (attr) {
					const match = attr.match(/changeTimeframe\(([^)]+)\)/);
					if (match && match[1]) {
						daysVal = parseFloat(match[1]);
					}
				}
				changeTimeframe(daysVal, { target: this, currentTarget: this });
			});
		});

		// Trade button click handling (buy/sell)
		document.querySelectorAll('.trade-btn').forEach(button => {
			button.addEventListener('click', async function (e) {
				e.preventDefault();

				const btn = this;
				// Determine form (closest .trading-form)
				const form = this.closest('.trading-form');

				// Determine buy or sell
				const isBuy = btn.classList.contains('buy');

				// Get trading mode (spot or leverage)
				const modeBtn = form.querySelector('.mode-btn.active');
				const mode = modeBtn ? modeBtn.getAttribute('data-mode') : 'spot';

				// Get leverage
				const leverageBtn = form.querySelector('.leverage-btn.active');
				const leverage = leverageBtn ? leverageBtn.getAttribute('data-leverage') : null;

				// Duration seconds
				const durationBtn = form.querySelector('.duration-btn.active');
				const duration = durationBtn ? parseInt(durationBtn.getAttribute('data-seconds')) : 60;

				// Investment amount (input[type="number"] inside the form)
				const amountInput = form.querySelector('input[type="number"]');
				const amount = amountInput ? parseFloat(amountInput.value) : NaN;

				// Basic validation
				if (isNaN(amount) || amount < 10) {
					alert('Please enter a valid investment amount (minimum $10).');
					return;
				}

				// Ensure we have coin data loaded
				if (!currentCrypto) {
					alert('Cryptocurrency data is still loading. Please wait a moment.');
					return;
				}

				// Build payload
				const payload = {
					symbol: currentCrypto.symbol,
					coin_id: currentCrypto.id,
					name: currentCrypto.name,
					trade_type: isBuy ? 'buy' : 'sell',
					mode: mode,
					leverage: leverage,
					duration: duration,
					amount: amount,
					entry_price: currentPrice,
					asset: 'crypto',
				};

				// UI: disable button while submitting
				btn.disabled = true;
				const originalHTML = btn.innerHTML;
				btn.innerHTML = '<i class="material-icons">hourglass_top</i> Placing...';

				try {
					const response = await fetch("{% url 'place_trade' %}", {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': getCSRFToken(),
							'Accept': 'application/json'
						},
						body: JSON.stringify(payload),
						credentials: 'same-origin'
					});

					if (!response.ok) {
						let errText = `HTTP ${response.status}`;
						try {
							const errJson = await response.json();
							if (errJson && errJson.message) errText = errJson.message;
						} catch (_) {}
						throw new Error(errText);
					}

					const result = await response.json();

					if (result.success) {
						alert('Trade placed successfully!');
						if (amountInput) amountInput.value = '';
						// reload to reflect new trade
						location.reload();
					} else {
						alert(result.message || 'Failed to place trade.');
					}
				} catch (error) {
					console.error('Error submitting trade:', error);
					alert('Error submitting trade. Please try again. ' + (error.message || ''));
				} finally {
					btn.disabled = false;
					btn.innerHTML = originalHTML;
				}
			});
		});

		// Mode / leverage / duration visual feedback (already present in your original script)
		document.addEventListener('click', function (e) {
			if (e.target.classList && e.target.classList.contains('mode-btn')) {
				const form = e.target.closest('.trading-form');
				form.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
				e.target.classList.add('active');

				const leverageOptions = form.querySelector('.leverage-options');
				if (e.target.getAttribute('data-mode') === 'leverage') {
					leverageOptions.classList.add('show');
				} else {
					leverageOptions.classList.remove('show');
				}
			}

			if (e.target.classList && e.target.classList.contains('leverage-btn')) {
				const form = e.target.closest('.trading-form');
				form.querySelectorAll('.leverage-btn').forEach(b => b.classList.remove('active'));
				e.target.classList.add('active');
			}

			if (e.target.classList && e.target.classList.contains('duration-btn')) {
				const form = e.target.closest('.trading-form');
				form.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('active'));
				e.target.classList.add('active');
			}
		});
	});

	// Initialize fetches and auto-refresh
	fetchCryptoList();

	// Refresh data every 60 seconds (reduced frequency to avoid rate limiting)
	setInterval(() => {
		if (cryptoData.length > 0 && currentCrypto && fetchAttempts === 0) {
			fetchCryptoList();
		}
	}, 60000);

	// Update footer year (preserve your original code)
	document.addEventListener('DOMContentLoaded', function () {
		const el = document.querySelector('.current-year');
		if (el) el.textContent = new Date().getFullYear();
	});
</script>
{% endblock %}

{% block content %}
<div class="content-body">
	<div class="container-fluid">

		<!-- Hidden tiny form to render csrf token and ensure a csrftoken cookie is available -->
		<form id="csrfForm" style="display:none;">{% csrf_token %}</form>

		<!-- Breadcrumb -->
		<div class="page-titles">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
				<li class="breadcrumb-item"><a href="javascript:void(0)">Market</a></li>
				<li class="breadcrumb-item active">Cryptocurrency</li>
			</ol>
		</div>

		<!-- Chart Panel - Full Width -->
		<div class="chart-panel">
			<div class="chart-header">
				<div class="crypto-selector-wrapper">
					<div class="crypto-selector">
						<img id="selectedLogo" class="selected-crypto-logo" src="" alt="" style="width:36px;height:36px;object-fit:contain;margin-right:8px;">
						<select id="cryptoDropdown" class="crypto-dropdown">
							<option value="">Loading cryptocurrencies...</option>
						</select>
					</div>
				</div>

				<div class="timeframe-selector">
					<button class="timeframe-btn active" onclick="changeTimeframe(0.003472)">5m</button>
					<button class="timeframe-btn" onclick="changeTimeframe(0.010417)">15m</button>
					<button class="timeframe-btn" onclick="changeTimeframe(0.020833)">30m</button>
					<button class="timeframe-btn" onclick="changeTimeframe(0.041667)">1h</button>
					<button class="timeframe-btn" onclick="changeTimeframe(0.166667)">4h</button>
				</div>
			</div>

			<div class="price-stats">
				<div class="stat-item">
					<div class="stat-label">Current Price</div>
					<div class="stat-value" id="currentPrice">$0.00</div>
				</div>
				<div class="stat-item">
					<div class="stat-label">24h Change</div>
					<div class="stat-value" id="change24h">0.00%</div>
				</div>
				<div class="stat-item">
					<div class="stat-label">Market Cap</div>
					<div class="stat-value" id="marketCap">$0.00</div>
				</div>
				<div class="stat-item">
					<div class="stat-label">24h Volume</div>
					<div class="stat-value" id="volume24h">$0.00</div>
				</div>
			</div>

			<div class="chart-container" style="position:relative;height:380px;">
				<div class="chart-wrapper" style="height:100%;">
					<canvas id="priceChart"></canvas>
				</div>
				<div class="loading" id="chartLoading" style="display: none;">Loading chart...</div>
			</div>

			<div id="errorContainer"></div>
		</div>

		<!-- Trading Section -->
		<div class="trading-section">
			<div class="trading-header">
				<h3>Live Trading</h3>
			</div>

			<div class="copy-advisory">
				<i class="material-icons">lightbulb</i>
				<div class="copy-advisory-text">
					<strong>Pro Tip!</strong>
					Consider copying expert traders instead of manual trading.
				</div>
				<a href="{% url 'copy_trader' %}" class="copy-advisory-link">Browse Experts</a>
			</div>

			<ul class="nav trading-tabs" role="tablist"
				style="margin-top: 20px; display: flex; justify-content: space-between;">
				<li class="nav-item" role="presentation" style="flex: 1;">
					<button type="button" class="nav-link tab-btn buy active" data-bs-toggle="tab" data-bs-target="#buyForm"
						role="tab" style="width: 100%;">
						<i class="material-icons">trending_up</i>
						BUY
					</button>
				</li>
				<li class="nav-item" role="presentation" style="flex: 1;">
					<button type="button" class="nav-link tab-btn sell" data-bs-toggle="tab" data-bs-target="#sellForm"
						role="tab" style="width: 100%;">
						<i class="material-icons">trending_down</i>
						SELL
					</button>
				</li>
			</ul>

			<div class="tab-content">
				<!-- Buy Form -->
				<div class="trading-form tab-pane fade show active" id="buyForm" role="tabpanel">
					<div class="form-row">
						<div class="form-group">
							<label class="form-label">Trading Mode</label>
							<div class="leverage-mode">
								<button type="button" class="mode-btn active" data-mode="spot">Spot Trading</button>
								<button type="button" class="mode-btn" data-mode="leverage">Leverage</button>
							</div>
							<div class="leverage-options" id="buyLeverageOptions">
								<button type="button" class="leverage-btn active" data-leverage="10">10X</button>
								<button type="button" class="leverage-btn" data-leverage="25">25X</button>
								<button type="button" class="leverage-btn" data-leverage="50">50X</button>
								<button type="button" class="leverage-btn" data-leverage="100">100X</button>
								<button type="button" class="leverage-btn" data-leverage="200">200X</button>
								<button type="button" class="leverage-btn" data-leverage="500">500X</button>
							</div>
						</div>

						<div class="form-group">
							<label class="form-label">Duration (Minutes)</label>
							<div class="duration-buttons">
								<button type="button" class="duration-btn active" data-seconds="60">1</button>
								<button type="button" class="duration-btn" data-seconds="180">3</button>
								<button type="button" class="duration-btn" data-seconds="300">5</button>
								<button type="button" class="duration-btn" data-seconds="900">15</button>
								<button type="button" class="duration-btn" data-seconds="1800">30</button>
							</div>
						</div>
					</div>

					<div class="form-row">
						<div class="form-group">
							<label class="form-label">Investment Amount (USD)</label>
							<input type="number" class="form-input" id="buyAmount" placeholder="Minimum $10" min="10"
								step="1">
						</div>

						<div class="form-group">
							<label class="form-label">&nbsp;</label>
							<button type="button" class="trade-btn buy">
								<i class="material-icons">rocket_launch</i>
								Open Buy Position
							</button>
						</div>
					</div>
				</div>

				<!-- Sell Form -->
				<div class="trading-form tab-pane fade" id="sellForm" role="tabpanel">
					<div class="form-row">
						<div class="form-group">
							<label class="form-label">Trading Mode</label>
							<div class="leverage-mode">
								<button type="button" class="mode-btn active" data-mode="spot">Spot Trading</button>
								<button type="button" class="mode-btn" data-mode="leverage">Leverage</button>
							</div>
							<div class="leverage-options" id="sellLeverageOptions">
								<button type="button" class="leverage-btn active" data-leverage="10">10X</button>
								<button type="button" class="leverage-btn" data-leverage="25">25X</button>
								<button type="button" class="leverage-btn" data-leverage="50">50X</button>
								<button type="button" class="leverage-btn" data-leverage="100">100X</button>
								<button type="button" class="leverage-btn" data-leverage="200">200X</button>
								<button type="button" class="leverage-btn" data-leverage="500">500X</button>
							</div>
						</div>

						<div class="form-group">
							<label class="form-label">Duration (Minutes)</label>
							<div class="duration-buttons">
								<button type="button" class="duration-btn active" data-seconds="60">1</button>
								<button type="button" class="duration-btn" data-seconds="180">3</button>
								<button type="button" class="duration-btn" data-seconds="300">5</button>
								<button type="button" class="duration-btn" data-seconds="900">15</button>
								<button type="button" class="duration-btn" data-seconds="1800">30</button>
							</div>
						</div>
					</div>

					<div class="form-row">
						<div class="form-group">
							<label class="form-label">Investment Amount (USD)</label>
							<input type="number" class="form-input" id="sellAmount" placeholder="Minimum $10" min="10"
								step="1">
						</div>

						<div class="form-group">
							<label class="form-label">&nbsp;</label>
							<button type="button" class="trade-btn sell">
								<i class="material-icons">rocket_launch</i>
								Open Sell Position
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Active Trades Section -->
		<div class="trades-section">
			<div class="trades-header">
				<h3>My Trades</h3>
			</div>

			<ul class="nav nav-tabs trade-tabs" role="tablist">
				<li class="nav-item" role="presentation">
					<button type="button" class="nav-link trade-tab active" id="open-tab" data-bs-toggle="tab"
						data-bs-target="#openTrades" role="tab">Open Trades</button>
				</li>
				<li class="nav-item" role="presentation">
					<button type="button" class="nav-link trade-tab" id="closed-tab" data-bs-toggle="tab"
						data-bs-target="#closedTrades" role="tab">Closed Trades</button>
				</li>
			</ul>

			<div class="tab-content">
				<div class="trades-list tab-pane fade show active" id="openTrades" role="tabpanel">
					{% for trade in open_trades %}
					<div class="trade-card {% if trade.pnl > 0 %}profit{% else %}loss{% endif %}">
						<div class="trade-header">
							<div class="trade-pair">{{ trade.symbol }}</div>
							<div class="trade-status active">Active</div>
						</div>
						<div class="trade-info">
							<span>Entry: ${{ trade.entry_price }}</span>
							<span>Current: ${{ trade.current_price }}</span>
						</div>
						<div class="trade-info">
							<span>Type: {{ trade.trade_type|title }} ({{ trade.mode }})</span>
							<span>Size: {{ trade.size }}</span>
						</div>
						<div class="trade-pnl {% if trade.pnl > 0 %}profit{% else %}loss{% endif %}">
							{% if trade.pnl > 0 %}+{% endif %}${{ trade.pnl }} ({{ trade.pnl_percent }}%)
						</div>
					</div>
					<hr>
					{% empty %}
					<div class="empty-trades">
						<i class="material-icons">inbox</i>
						<p>No open trades yet. Start trading above!</p>
					</div>
					{% endfor %}

				</div>

				<div class="trades-list tab-pane fade" id="closedTrades" role="tabpanel">
					{% for trade in closed_trades %}
					<div class="trade-card {% if trade.pnl > 0 %}profit{% else %}loss{% endif %}">
						<div class="trade-header">
							<div class="trade-pair">{{ trade.symbol }}</div>
							<div class="trade-status">Closed</div>
						</div>
						<div class="trade-info">
							<span>Entry: ${{ trade.entry_price }}</span>
							<span>Exit: ${{ trade.exit_price }}</span>
						</div>
						<div class="trade-info">
							<span>Type: {{ trade.trade_type|title }} ({{ trade.mode }})</span>
							<span>Closed: {{ trade.closed_at|timesince }} ago</span>
						</div>
						<div class="trade-pnl {% if trade.pnl > 0 %}profit{% else %}loss{% endif %}">
							{% if trade.pnl > 0 %}+{% endif %}${{ trade.pnl }} ({{ trade.pnl_percent }}%)
						</div>
					</div>
					<hr>
					{% empty %}
					<div class="empty-trades">
						<i class="material-icons">history</i>
						<p>No closed trades yet.</p>
					</div>
					{% endfor %}

				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}
