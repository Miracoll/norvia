{% extends 'account/base.html' %}
{% load static %}
{% block content %}
<div class="content-body">
    <div class="container-fluid">
        <!-- Breadcrumb -->
        <div class="page-titles">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="dashboard.html">Home</a></li>
                <li class="breadcrumb-item"><a href="javascript:void(0)">Wallet</a></li>
                <li class="breadcrumb-item active">Withdrawal History</li>
            </ol>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-content">
                <div>
                    <h3>Withdrawal History</h3>
                    <p class="page-header-subtitle">View all your withdrawal transactions and their status</p>
                </div>
                <div class="header-actions">
                    <a href="withdraw.html" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px;">
                        <i class="material-icons" style="font-size: 20px;">send</i>
                        New Withdrawal
                    </a>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-card">
            <div class="filters-row">
                <div class="filter-group">
                    <label class="filter-label">Search</label>
                    <div class="search-wrapper">
                        <i class="material-icons">search</i>
                        <input type="text" class="filter-input" id="searchInput" placeholder="Transaction ID, Amount...">
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select class="filter-select" id="statusFilter">
                        <option value="all">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="processing">Processing</option>
                        <option value="pending">Pending</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Currency</label>
                    <select class="filter-select" id="currencyFilter">
                        <option value="all">All Currencies</option>
                        <option value="BTC">Bitcoin (BTC)</option>
                        <option value="ETH">Ethereum (ETH)</option>
                        <option value="USDT">Tether (USDT)</option>
                        <option value="BNB">Binance Coin (BNB)</option>
                    </select>
                </div>
                <div class="filter-group" style="display: flex; gap: 8px;">
                    <button class="filter-btn primary" onclick="applyFilters()">
                        <i class="material-icons" style="font-size: 18px;">filter_list</i>
                        Apply
                    </button>
                    <button class="filter-btn secondary" onclick="resetFilters()">
                        <i class="material-icons" style="font-size: 18px;">refresh</i>
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Withdrawals Table -->
        <div class="withdrawals-card">
            <table class="withdrawals-table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Date & Time</th>
                        <th>Currency</th>
                        <th>Amount</th>
                        <th>Destination</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="withdrawalsTableBody">
                    <!-- Sample Data - Will be populated dynamically -->
                </tbody>
            </table>

            <!-- Empty State (shown when no results) -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="material-icons">inbox</i>
                <h4>No Withdrawals Found</h4>
                <p>You haven't made any withdrawals yet or no results match your filters.</p>
                <a href="withdraw.html" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px;">
                    <i class="material-icons">send</i>
                    Make Your First Withdrawal
                </a>
            </div>

            <!-- Pagination -->
            <div class="pagination-wrapper" id="paginationWrapper">
                <div class="pagination-info">
                    Showing <strong id="showingStart">1</strong> to <strong id="showingEnd">10</strong> of <strong id="totalRecords">20</strong> withdrawals
                </div>
                <div class="pagination">
                    <button class="page-btn" onclick="changePage('prev')" id="prevBtn">
                        <i class="material-icons" style="font-size: 18px;">chevron_left</i>
                    </button>
                    <button class="page-btn active" onclick="changePage(1)">1</button>
                    <button class="page-btn" onclick="changePage(2)">2</button>
                    <button class="page-btn" onclick="changePage(3)">3</button>
                    <button class="page-btn" onclick="changePage('next')" id="nextBtn">
                        <i class="material-icons" style="font-size: 18px;">chevron_right</i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_scripts %}
<script>
    // Sample withdrawal data (in production, this will come from backend)
    const sampleWithdrawals = [
        {
            id: 'WDR-2025-001234',
            date: '2025-01-15 10:25:00',
            currency: 'USDT',
            amount: 300.00,
            destination: 'TRC20: TYui...x8Kp',
            status: 'completed'
        },
        {
            id: 'WDR-2025-001233',
            date: '2025-01-14 16:42:00',
            currency: 'BTC',
            amount: 0.012,
            destination: 'Bitcoin: 1A1z...Q5eG',
            status: 'completed'
        },
        {
            id: 'WDR-2025-001232',
            date: '2025-01-13 14:18:00',
            currency: 'ETH',
            amount: 0.8,
            destination: 'ERC20: 0x742...a91b',
            status: 'processing'
        },
        {
            id: 'WDR-2025-001231',
            date: '2025-01-12 09:55:00',
            currency: 'USDT',
            amount: 750.00,
            destination: 'BEP20: 0xB8c...d3F4',
            status: 'completed'
        },
        {
            id: 'WDR-2025-001230',
            date: '2025-01-11 11:30:00',
            currency: 'BNB',
            amount: 1.5,
            destination: 'BEP20: 0x958...c2A1',
            status: 'pending'
        },
        {
            id: 'WDR-2025-001229',
            date: '2025-01-10 15:20:00',
            currency: 'USDT',
            amount: 150.00,
            destination: 'PayPal: user@email.com',
            status: 'rejected'
        },
        {
            id: 'WDR-2025-001228',
            date: '2025-01-09 12:45:00',
            currency: 'ETH',
            amount: 1.0,
            destination: 'ERC20: 0x3E8...b7C2',
            status: 'completed'
        },
        {
            id: 'WDR-2025-001227',
            date: '2025-01-08 08:10:00',
            currency: 'BTC',
            amount: 0.02,
            destination: 'Bitcoin: 3FZb...M2rT',
            status: 'completed'
        }
    ];

    let currentPage = 1;
    let itemsPerPage = 10;
    let filteredWithdrawals = [...sampleWithdrawals];

    // Render withdrawals table
    function renderWithdrawals() {
        const tbody = document.getElementById('withdrawalsTableBody');
        const emptyState = document.getElementById('emptyState');
        const paginationWrapper = document.getElementById('paginationWrapper');

        if (filteredWithdrawals.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'block';
            paginationWrapper.style.display = 'none';
            return;
        }

        emptyState.style.display = 'none';
        paginationWrapper.style.display = 'flex';

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageWithdrawals = filteredWithdrawals.slice(start, end);

        tbody.innerHTML = pageWithdrawals.map(withdrawal => {
            const statusConfig = {
                completed: { icon: 'check_circle', label: 'Completed' },
                processing: { icon: 'sync', label: 'Processing' },
                pending: { icon: 'schedule', label: 'Pending' },
                rejected: { icon: 'cancel', label: 'Rejected' }
            };

            const status = statusConfig[withdrawal.status];
            const usdAmount = withdrawal.currency === 'USDT' ? withdrawal.amount : withdrawal.amount * getPriceInUSD(withdrawal.currency);

            return `
                <tr>
                    <td>
                        <strong>${withdrawal.id}</strong>
                    </td>
                    <td>${formatDate(withdrawal.date)}</td>
                    <td>
                        <div class="currency-badge">
                            <div class="currency-icon">${withdrawal.currency.substring(0, 3)}</div>
                            ${withdrawal.currency}
                        </div>
                    </td>
                    <td>
                        <div class="amount-display">${withdrawal.amount} ${withdrawal.currency}</div>
                        <div class="amount-usd">â‰ˆ $${usdAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </td>
                    <td style="font-size: 13px; color: var(--gray-500);">${withdrawal.destination}</td>
                    <td>
                        <span class="status-badge ${withdrawal.status}">
                            <i class="material-icons">${status.icon}</i>
                            ${status.label}
                        </span>
                    </td>
                    <td>
                        <a href="withdrawal-details.html?id=${withdrawal.id}" class="action-btn">
                            <i class="material-icons">visibility</i>
                            View
                        </a>
                    </td>
                </tr>
            `;
        }).join('');

        updatePagination();
    }

    // Format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        const options = {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return date.toLocaleDateString('en-US', options);
    }

    // Get price in USD (mock prices for demo)
    function getPriceInUSD(currency) {
        const prices = {
            BTC: 45000,
            ETH: 2500,
            USDT: 1,
            BNB: 350
        };
        return prices[currency] || 1;
    }

    // Apply filters
    function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const currencyFilter = document.getElementById('currencyFilter').value;

        filteredWithdrawals = sampleWithdrawals.filter(withdrawal => {
            const matchesSearch = !searchTerm ||
                withdrawal.id.toLowerCase().includes(searchTerm) ||
                withdrawal.amount.toString().includes(searchTerm) ||
                withdrawal.destination.toLowerCase().includes(searchTerm);

            const matchesStatus = statusFilter === 'all' || withdrawal.status === statusFilter;
            const matchesCurrency = currencyFilter === 'all' || withdrawal.currency === currencyFilter;

            return matchesSearch && matchesStatus && matchesCurrency;
        });

        currentPage = 1;
        renderWithdrawals();
    }

    // Reset filters
    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = 'all';
        document.getElementById('currencyFilter').value = 'all';
        filteredWithdrawals = [...sampleWithdrawals];
        currentPage = 1;
        renderWithdrawals();
    }

    // Update pagination
    function updatePagination() {
        const totalPages = Math.ceil(filteredWithdrawals.length / itemsPerPage);
        const start = (currentPage - 1) * itemsPerPage + 1;
        const end = Math.min(currentPage * itemsPerPage, filteredWithdrawals.length);

        document.getElementById('showingStart').textContent = start;
        document.getElementById('showingEnd').textContent = end;
        document.getElementById('totalRecords').textContent = filteredWithdrawals.length;

        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;
    }

    // Change page
    function changePage(page) {
        const totalPages = Math.ceil(filteredWithdrawals.length / itemsPerPage);

        if (page === 'prev' && currentPage > 1) {
            currentPage--;
        } else if (page === 'next' && currentPage < totalPages) {
            currentPage++;
        } else if (typeof page === 'number') {
            currentPage = page;
        }

        renderWithdrawals();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Add event listeners for real-time search
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('currencyFilter').addEventListener('change', applyFilters);

    // Initialize
    renderWithdrawals();
    document.querySelector('.current-year').textContent = new Date().getFullYear();
</script>
{% endblock extra_scripts %}