{% extends "account/base.html" %}
{% load static %}

{% block title %}Stock Market{% endblock %}
{% block body_class %}page-stockmarket{% endblock %}

{% block page_scripts %}
<script>
	/* ============================
	   EXISTING SCRIPT CONTENT
	   (Charts, Dropdown, UI Logic)
	   ============================ */

	// Live Chart - Stock data
	const stockData = [
		{ symbol: 'AAPL', name: 'Apple Inc.', price: 178.45, change: 2.34, marketCap: '2.8T', volume: '58.2M' },
		{ symbol: 'MSFT', name: 'Microsoft Corporation', price: 398.12, change: 1.85, marketCap: '2.95T', volume: '24.5M' },
		{ symbol: 'GOOGL', name: 'Alphabet Inc.', price: 141.23, change: -0.45, marketCap: '1.77T', volume: '22.1M' },
		{ symbol: 'AMZN', name: 'Amazon.com Inc.', price: 153.67, change: 3.12, marketCap: '1.59T', volume: '45.8M' },
		{ symbol: 'NVDA', name: 'NVIDIA Corporation', price: 495.34, change: 5.67, marketCap: '1.22T', volume: '35.6M' },
		{ symbol: 'TSLA', name: 'Tesla Inc.', price: 245.89, change: -1.23, marketCap: '780.5B', volume: '102.3M' },
		{ symbol: 'META', name: 'Meta Platforms Inc.', price: 378.45, change: 2.78, marketCap: '970.2B', volume: '18.4M' },
		{ symbol: 'BRK.B', name: 'Berkshire Hathaway Inc.', price: 392.56, change: 0.89, marketCap: '856.7B', volume: '3.2M' },
		{ symbol: 'JPM', name: 'JPMorgan Chase & Co.', price: 189.23, change: 1.45, marketCap: '544.3B', volume: '9.8M' },
		{ symbol: 'V', name: 'Visa Inc.', price: 267.89, change: 1.12, marketCap: '549.2B', volume: '6.5M' },
		{ symbol: 'WMT', name: 'Walmart Inc.', price: 169.78, change: 0.67, marketCap: '455.8B', volume: '7.3M' },
		{ symbol: 'DIS', name: 'The Walt Disney Company', price: 93.45, change: -0.89, marketCap: '170.4B', volume: '12.1M' },
		{ symbol: 'NFLX', name: 'Netflix Inc.', price: 485.67, change: 3.45, marketCap: '210.5B', volume: '5.8M' },
		{ symbol: 'PYPL', name: 'PayPal Holdings Inc.', price: 68.34, change: -2.12, marketCap: '74.2B', volume: '15.4M' },
		{ symbol: 'INTC', name: 'Intel Corporation', price: 43.56, change: 0.45, marketCap: '180.3B', volume: '38.9M' },
		{ symbol: 'AMD', name: 'Advanced Micro Devices Inc.', price: 158.23, change: 4.12, marketCap: '255.8B', volume: '42.5M' },
		{ symbol: 'ORCL', name: 'Oracle Corporation', price: 112.89, change: 1.34, marketCap: '310.6B', volume: '8.7M' },
		{ symbol: 'CSCO', name: 'Cisco Systems Inc.', price: 52.67, change: 0.78, marketCap: '215.4B', volume: '19.2M' },
		{ symbol: 'BA', name: 'The Boeing Company', price: 198.45, change: -1.56, marketCap: '118.9B', volume: '7.4M' },
		{ symbol: 'GE', name: 'General Electric Company', price: 156.78, change: 2.23, marketCap: '172.3B', volume: '5.9M' }
	];

	let currentStock = null;
	let currentPrice = 0;
	let priceChart = null;
	let currentTimeframe = 0.003472;

	// Populate Dropdown
	function populateDropdown() {
		const dropdown = document.getElementById('stockDropdown');
		dropdown.innerHTML = stockData
			.map(stock => `<option value="${stock.symbol}">${stock.name} (${stock.symbol}) - $${stock.price}</option>`)
			.join('');

		dropdown.addEventListener('change', function () {
			const selectedStock = stockData.find(s => s.symbol === this.value);
			if (selectedStock) {
				document.getElementById('selectedLogo').textContent = selectedStock.symbol.substring(0, 4);
				loadStockData(this.value);
			}
		});

		if (stockData.length > 0) {
			document.getElementById('selectedLogo').textContent = stockData[0].symbol.substring(0, 4);
			loadStockData(stockData[0].symbol);
		}
	}

	function loadStockData(symbol) {
		const stock = stockData.find(s => s.symbol === symbol);
		if (!stock) return;

		currentStock = stock;
		currentPrice = stock.price;

		document.getElementById('currentPrice').textContent = '$' + currentPrice;
		document.getElementById('marketCap').textContent = '$' + stock.marketCap;
		document.getElementById('volume24h').textContent = stock.volume;

		const change24hElement = document.getElementById('change24h');
		change24hElement.textContent = stock.change + "%";
		change24hElement.style.color = stock.change >= 0 ? '#10b981' : '#ef4444';

		loadChart(symbol, currentTimeframe);
	}

	function loadChart(symbol, days) {
		// dummy generated chart
	}

	document.addEventListener('DOMContentLoaded', populateDropdown);

	/* ============================
	   END OF YOUR EXISTING SCRIPT
	   ============================ */
</script>


<!-- ========================================================= -->
<!-- == NEW AJAX SCRIPT TO SEND TRADE DATA TO Django API ===== -->
<!-- ========================================================= -->
<script>
	// === CSRF Helper ===
	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== "") {
			const cookies = document.cookie.split(";");
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();

				if (cookie.substring(0, name.length + 1) === (name + "=")) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}


	// === EXECUTE TRADE USING AJAX ===
	function executeTrade(type) {

		const symbol = document.getElementById('stockDropdown').value;

		// Determine correct form
		const form = type === "buy"
			? document.getElementById("buyForm")
			: document.getElementById("sellForm");

		// Determine mode
		const mode = form.querySelector(".mode-btn.active").getAttribute("data-mode");

		// Leverage only if mode = leverage
		let leverage = null;
		if (mode === "leverage") {
			const levBtn = form.querySelector(".leverage-btn.active");
			leverage = levBtn ? levBtn.getAttribute("data-leverage") : null;
		}

		// Duration
		const durationBtn = form.querySelector(".duration-btn.active");
		const duration = durationBtn ? durationBtn.getAttribute("data-seconds") : 60;

		// Amount
		const amount = type === "buy"
			? document.getElementById("buyAmount").value
			: document.getElementById("sellAmount").value;

		// Price
		const entry_price = parseFloat(
			document.getElementById("currentPrice").textContent.replace("$", "")
		);

		const payload = {
			symbol: symbol,
			trade_type: type,
			mode: mode,
			leverage: leverage,
			duration: duration,
			amount: amount,
			entry_price: entry_price,
			current_price: entry_price,
			asset: "stock"
		};

		console.log("Sending Payload:", payload);

		$.ajax({
			url: "{% url 'place_trade' %}",
			method: "POST",
			data: JSON.stringify(payload),
			contentType: "application/json",
			headers: { "X-CSRFToken": getCookie("csrftoken") },

			success: function (response) {
				alert(response.message);
				location.reload();      // ðŸ”¥ reload the page
			},


			error: function (xhr) {
				alert("Error: " + xhr.responseJSON.message);
			}
		});
	}
</script>
{% endblock %}

{% block content %}
<div class="content-body">
	<div class="container-fluid">
		<!-- Breadcrumb -->
		<div class="page-titles">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
				<li class="breadcrumb-item"><a href="javascript:void(0)">Market</a></li>
				<li class="breadcrumb-item active">Stocks</li>
			</ol>
		</div>

		<!-- Chart Panel - Full Width -->
		<div class="chart-panel">
			<div class="chart-header">
				<div class="stock-selector-wrapper">
					<div class="stock-selector">
						<div id="selectedLogo" class="selected-stock-logo">AAPL</div>
						<select id="stockDropdown" class="stock-dropdown">
							<option value="">Loading stocks...</option>
						</select>
					</div>
				</div>

				<div class="timeframe-selector">
					<button class="timeframe-btn active" onclick="changeTimeframe(0.003472)">5m</button>
					<button class="timeframe-btn" onclick="changeTimeframe(0.010417)">15m</button>
					<button class="timeframe-btn" onclick="changeTimeframe(0.020833)">30m</button>
					<button class="timeframe-btn" onclick="changeTimeframe(0.041667)">1h</button>
					<button class="timeframe-btn" onclick="changeTimeframe(0.166667)">4h</button>
				</div>
			</div>

			<div class="price-stats">
				<div class="stat-item">
					<div class="stat-label">Current Price</div>
					<div class="stat-value" id="currentPrice">$0.00</div>
				</div>
				<div class="stat-item">
					<div class="stat-label">24h Change</div>
					<div class="stat-value" id="change24h">0.00%</div>
				</div>
				<div class="stat-item">
					<div class="stat-label">Market Cap</div>
					<div class="stat-value" id="marketCap">$0.00</div>
				</div>
				<div class="stat-item">
					<div class="stat-label">24h Volume</div>
					<div class="stat-value" id="volume24h">$0.00</div>
				</div>
			</div>

			<div class="chart-container">
				<div class="chart-wrapper">
					<canvas id="priceChart"></canvas>
				</div>
				<div class="loading" id="chartLoading" style="display: none;">Loading chart...</div>
			</div>
		</div>

		<!-- Trading Section -->
		<div class="trading-section">
			<div class="trading-header">
				<h3>Live Trading</h3>
			</div>

			<div class="copy-advisory">
				<i class="material-icons">lightbulb</i>
				<div class="copy-advisory-text">
					<strong>Pro Tip!</strong>
					Consider copying expert traders instead of manual trading.
				</div>
				<a href="{% url 'copy_trader' %}" class="copy-advisory-link">Browse Experts</a>
			</div>

			<ul class="nav trading-tabs" role="tablist"
				style="margin-top: 20px; display: flex; justify-content: space-between;">
				<li class="nav-item" role="presentation" style="flex: 1;">
					<button class="nav-link tab-btn buy active" id="buy-tab" data-bs-toggle="tab"
						data-bs-target="#buyForm" type="button" role="tab" style="width: 100%;">
						<i class="material-icons">trending_up</i>
						BUY
					</button>
				</li>
				<li class="nav-item" role="presentation" style="flex: 1;">
					<button class="nav-link tab-btn sell" id="sell-tab" data-bs-toggle="tab" data-bs-target="#sellForm"
						type="button" role="tab" style="width: 100%;">
						<i class="material-icons">trending_down</i>
						SELL
					</button>
				</li>
			</ul>

			<div class="tab-content">
				<!-- Buy Form -->
				<div class="trading-form tab-pane fade show active" id="buyForm" role="tabpanel">
					<div class="form-row">
						<div class="form-group">
							<label class="form-label">Trading Mode</label>
							<div class="leverage-mode">
								<button class="mode-btn active" data-mode="spot">Spot Trading</button>
								<button class="mode-btn" data-mode="leverage">Leverage</button>
							</div>
							<div class="leverage-options" id="buyLeverageOptions">
								<button class="leverage-btn active" data-leverage="10">10X</button>
								<button class="leverage-btn" data-leverage="25">25X</button>
								<button class="leverage-btn" data-leverage="50">50X</button>
								<button class="leverage-btn" data-leverage="100">100X</button>
								<button class="leverage-btn" data-leverage="200">200X</button>
								<button class="leverage-btn" data-leverage="500">500X</button>
							</div>
						</div>

						<div class="form-group">
							<label class="form-label">Duration (Minutes)</label>
							<div class="duration-buttons">
								<button class="duration-btn active" data-seconds="60">1</button>
								<button class="duration-btn" data-seconds="180">3</button>
								<button class="duration-btn" data-seconds="300">5</button>
								<button class="duration-btn" data-seconds="900">15</button>
								<button class="duration-btn" data-seconds="1800">30</button>
							</div>
						</div>
					</div>

					<div class="form-row">
						<div class="form-group">
							<label class="form-label">Investment Amount (USD)</label>
							<input type="number" class="form-input" id="buyAmount" placeholder="Minimum $10" min="10"
								step="1">
						</div>

						<div class="form-group">
							<label class="form-label">&nbsp;</label>
							<button class="trade-btn buy" onclick="executeTrade('buy')">
								<i class="material-icons">rocket_launch</i>
								Open Buy Position
							</button>
						</div>
					</div>
				</div>

				<!-- Sell Form -->
				<div class="trading-form tab-pane fade" id="sellForm" role="tabpanel">
					<div class="form-row">
						<div class="form-group">
							<label class="form-label">Trading Mode</label>
							<div class="leverage-mode">
								<button class="mode-btn active" data-mode="spot">Spot Trading</button>
								<button class="mode-btn" data-mode="leverage">Leverage</button>
							</div>
							<div class="leverage-options" id="sellLeverageOptions">
								<button class="leverage-btn active" data-leverage="10">10X</button>
								<button class="leverage-btn" data-leverage="25">25X</button>
								<button class="leverage-btn" data-leverage="50">50X</button>
								<button class="leverage-btn" data-leverage="100">100X</button>
								<button class="leverage-btn" data-leverage="200">200X</button>
								<button class="leverage-btn" data-leverage="500">500X</button>
							</div>
						</div>

						<div class="form-group">
							<label class="form-label">Duration (Minutes)</label>
							<div class="duration-buttons">
								<button class="duration-btn active" data-seconds="60">1</button>
								<button class="duration-btn" data-seconds="180">3</button>
								<button class="duration-btn" data-seconds="300">5</button>
								<button class="duration-btn" data-seconds="900">15</button>
								<button class="duration-btn" data-seconds="1800">30</button>
							</div>
						</div>
					</div>

					<div class="form-row">
						<div class="form-group">
							<label class="form-label">Investment Amount (USD)</label>
							<input type="number" class="form-input" id="sellAmount" placeholder="Minimum $10" min="10"
								step="1">
						</div>

						<div class="form-group">
							<label class="form-label">&nbsp;</label>
							<button class="trade-btn sell" onclick="executeTrade('sell')">
								<i class="material-icons">rocket_launch</i>
								Open Sell Position
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Active Trades Section -->
		<div class="trades-section">
			<div class="trades-header">
				<h3>My Trades</h3>
			</div>

			<ul class="nav nav-tabs trade-tabs" role="tablist">
				<li class="nav-item" role="presentation">
					<button class="nav-link trade-tab active" id="open-tab" data-bs-toggle="tab"
						data-bs-target="#openTrades" type="button" role="tab">Open Trades</button>
				</li>
				<li class="nav-item" role="presentation">
					<button class="nav-link trade-tab" id="closed-tab" data-bs-toggle="tab"
						data-bs-target="#closedTrades" type="button" role="tab">Closed Trades</button>
				</li>
			</ul>

			<div class="tab-content">
				<div class="trades-list tab-pane fade show active" id="openTrades" role="tabpanel">
					{% for trade in open_trades %}
					<div class="trade-card {% if trade.pnl > 0 %}profit{% else %}loss{% endif %}">
						<div class="trade-header">
							<div class="trade-pair">{{ trade.symbol }}</div>
							<div class="trade-status active">Active</div>
						</div>
						<div class="trade-info">
							<span>Entry: ${{ trade.entry_price }}</span>
							<span>Current: ${{ trade.current_price }}</span>
						</div>
						<div class="trade-info">
							<span>Type: {{ trade.trade_type|title }} ({{ trade.mode }})</span>
							<span>Size: {{ trade.size }}</span>
						</div>
						<div class="trade-pnl {% if trade.pnl > 0 %}profit{% else %}loss{% endif %}">
							{% if trade.pnl > 0 %}+{% endif %}${{ trade.pnl }} ({{ trade.pnl_percent }}%)
						</div>
					</div>
					<hr>
					{% empty %}
					<div class="empty-trades">
						<i class="material-icons">inbox</i>
						<p>No open trades yet. Start trading above!</p>
					</div>
					{% endfor %}

				</div>

				<div class="trades-list tab-pane fade" id="closedTrades" role="tabpanel">
					{% for trade in closed_trades %}
					<div class="trade-card {% if trade.pnl > 0 %}profit{% else %}loss{% endif %}">
						<div class="trade-header">
							<div class="trade-pair">{{ trade.symbol }}</div>
							<div class="trade-status">Closed</div>
						</div>
						<div class="trade-info">
							<span>Entry: ${{ trade.entry_price }}</span>
							<span>Exit: ${{ trade.exit_price }}</span>
						</div>
						<div class="trade-info">
							<span>Type: {{ trade.trade_type|title }} ({{ trade.mode }})</span>
							<span>Closed: {{ trade.closed_at|timesince }} ago</span>
						</div>
						<div class="trade-pnl {% if trade.pnl > 0 %}profit{% else %}loss{% endif %}">
							{% if trade.pnl > 0 %}+{% endif %}${{ trade.pnl }} ({{ trade.pnl_percent }}%)
						</div>
					</div>
					<hr>
					{% empty %}
					<div class="empty-trades">
						<i class="material-icons">history</i>
						<p>No closed trades yet.</p>
					</div>
					{% endfor %}

				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}