{%extends "account/base.html" %}
{% load static %}

{% block title %}2FA Setup{% endblock %}

{% block body_class %}page-twofa{% endblock %}

{% block content %}
<div class="content-body default-height">
	<div class="container-fluid">
		<!-- Breadcrumb -->
		<div class="row">
			<div class="col-xl-12">
				<div class="page-titles">
					<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
						<ol class="breadcrumb">
							<li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
							<li class="breadcrumb-item"><a href="{% url 'settings' %}">Settings</a></li>
							<li class="breadcrumb-item active" aria-current="page">2FA Setup</li>
						</ol>
					</nav>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-xl-12">
				<div class="twofa-container">
					<!-- 2FA Header -->
					<div class="twofa-header">
						<div class="twofa-header-content">
							<i class="material-icons" style="font-size: 56px; margin-bottom: 15px;">security</i>
							<h1>Two-Factor Authentication (2FA)</h1>
							<p>Add an extra layer of security to your account with Google Authenticator</p>
						</div>
					</div>

					<!-- Step 1: Download Authenticator App -->
					<div class="step-card">
						<div class="step-header">
							<div class="step-number">1</div>
							<h2 class="step-title">Download Authenticator App</h2>
						</div>
						<p class="step-description">
							Download and install Google Authenticator on your mobile device. This app will generate time-based one-time passwords (TOTP) for secure login.
						</p>

						<div class="info-box-2fa">
							<i class="material-icons">info</i>
							<div class="info-box-2fa-content">
								<h4>Recommended Authenticator Apps</h4>
								<p><strong>Google Authenticator:</strong> Available for iOS and Android<br>
								<strong>Alternatives:</strong> Microsoft Authenticator, Authy, 1Password</p>
							</div>
						</div>

						<div style="display: flex; gap: 12px; flex-wrap: wrap;">
							<button class="btn-secondary">
								<i class="material-icons">android</i>
								Download for Android
							</button>
							<button class="btn-secondary">
								<i class="material-icons">apple</i>
								Download for iOS
							</button>
						</div>
					</div>

					<!-- Step 2: Scan QR Code -->
					<div class="step-card">
						<div class="step-header">
							<div class="step-number">2</div>
							<h2 class="step-title">Scan QR Code</h2>
						</div>
						<p class="step-description">
							Open Google Authenticator and scan this QR code to add your Norvia.io account. Alternatively, you can manually enter the setup key below.
						</p>

						<div class="qr-code-container">
							<div class="qr-code-box">
								<!-- TODO: Generate actual QR code on backend -->
								<!-- <i class="material-icons qr-code-placeholder">qr_code_2</i> -->
								<img src="{{qrcode}}" alt="">
							</div>
							<p style="font-size: 14px; color: #6b7280; margin: 0;">Scan this QR code with Google Authenticator</p>
						</div>

						<div class="manual-code-section">
							<div class="manual-code-label">Can't scan? Enter this code manually:</div>
							<div class="manual-code" id="secretKey">JBSW Y3DP EHPK 3PXP</div>
							<button class="btn-copy-code">
								<i class="material-icons" data-bs-toggle="tooltip" title="Copy" style="cursor: pointer;">content_copy</i>
								Copy Code
							</button>
						</div>
					</div>

					<!-- Step 3: Verify Code -->
					<div class="step-card">
						<div class="step-header">
							<div class="step-number">3</div>
							<h2 class="step-title">Verify Authentication Code</h2>
						</div>
						<p class="step-description">
							Enter the 6-digit code from your Google Authenticator app to verify the setup.
						</p>

						<form id="verify2faForm" action="{% url 'two_factor_verify' %}" method="post">
							{% csrf_token %}
							<div class="form-group-2fa">
								<label class="form-label-2fa">6-Digit Verification Code *</label>
								<input type="text" name="token" class="form-input-2fa verification-code-input" id="verificationCode" placeholder="000000" maxlength="6" required>
							</div>

							<button type="submit" class="btn-2fa">
								<i class="material-icons">verified_user</i>
								Verify & Continue
							</button>
						</form>
					</div>

					<!-- Step 4: Backup Phone Number -->
					<div class="step-card" id="step4" style="display: none;">
						<div class="step-header">
							<div class="step-number">4</div>
							<h2 class="step-title">Add Backup Phone Number</h2>
						</div>
						<p class="step-description">
							Add a phone number as a backup method to receive verification codes via SMS if you lose access to your authenticator app.
						</p>

						<div class="info-box-2fa">
							<i class="material-icons">info</i>
							<div class="info-box-2fa-content">
								<h4>Why add a backup?</h4>
								<p>If you lose your phone or uninstall the authenticator app, you can still access your account using SMS verification.</p>
							</div>
						</div>

						<form id="backupPhoneForm">
							<div class="form-group-2fa">
								<label class="form-label-2fa">Phone Number *</label>
								<input type="tel" class="form-input-2fa" id="backupPhone" placeholder="+1 (555) 000-0000" required>
							</div>

							<div class="form-group-2fa">
								<label class="form-label-2fa">SMS Verification Code *</label>
								<input type="text" class="form-input-2fa verification-code-input" id="smsCode" placeholder="000000" maxlength="6" required>
								<button type="button" class="btn-secondary" style="margin-top: 12px;">
									<i class="material-icons">send</i>
									Send SMS Code
								</button>
							</div>

							<button type="button" class="btn-2fa">
								<i class="material-icons">check_circle</i>
								Verify Phone Number
							</button>
						</form>
					</div>

					<!-- Step 5: Save Recovery Codes -->
					<div class="step-card" id="step5" style="display: none;">
						<div class="step-header">
							<div class="step-number">5</div>
							<h2 class="step-title">Save Recovery Codes</h2>
						</div>
						<p class="step-description">
							Save these recovery codes in a secure place. Each code can be used once to access your account if you lose access to your 2FA methods.
						</p>

						<div class="warning-box">
							<i class="material-icons">warning</i>
							<div class="warning-box-content">
								<h4>Important: Store These Codes Safely</h4>
								<p>Each recovery code can only be used once. Store them in a secure location like a password manager. If you lose both your authenticator app and backup phone, these codes are your only way to access your account.</p>
							</div>
						</div>

						<div class="recovery-codes-container">
							<div class="recovery-codes-grid" id="recoveryCodes">
								<!-- Recovery codes will be generated here -->
								<div class="recovery-code-item">A5K3-9FH2-KL7P</div>
								<div class="recovery-code-item">B8M4-2GJ6-NQ9R</div>
								<div class="recovery-code-item">C2N7-5HP8-MT3S</div>
								<div class="recovery-code-item">D9P1-8KR4-VW6X</div>
								<div class="recovery-code-item">E4Q6-3LS9-YZ2A</div>
								<div class="recovery-code-item">F7R2-6MT5-BC8D</div>
								<div class="recovery-code-item">G1S8-9NV3-EF4G</div>
								<div class="recovery-code-item">H5T4-2PW7-HJ9K</div>
							</div>

							<button class="btn-secondary" style="width: 100%;">
								<i class="material-icons">download</i>
								Download Recovery Codes
							</button>
						</div>

						<div class="checkbox-container">
							<input type="checkbox" id="confirmSaved">
							<label for="confirmSaved">I have saved these recovery codes in a secure location</label>
						</div>

						<button type="button" class="btn-2fa">
							<i class="material-icons">done_all</i>
							Complete 2FA Setup
						</button>
					</div>

				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
// Copy secret key to clipboard with visual feedback
document.querySelector('.btn-copy-code').addEventListener('click', function() {
	const secretKey = document.getElementById('secretKey').textContent.trim();
	const btn = this;
	const originalHTML = btn.innerHTML;

	navigator.clipboard.writeText(secretKey).then(function() {
		btn.innerHTML = '<i class="material-icons">check</i>Copied!';
		btn.style.background = '#10b981';
		btn.style.color = '#fff';

		setTimeout(function() {
			btn.innerHTML = originalHTML;
			btn.style.background = '';
			btn.style.color = '';
		}, 2000);
	}).catch(function(err) {
		alert('Failed to copy code. Please copy manually.');
	});
});

// TODO: Django backend will handle:
// - Generate unique 2FA secret key for user
// - Store secret key securely in database (encrypted)
// - Generate QR code image using pyotp or similar library
// - Verify 6-digit code from user's authenticator app
// - Enable 2FA on user account
// - Generate recovery codes (8 unique codes)
// - Store recovery codes securely (hashed)
// - Send confirmation email when 2FA is enabled
// - Handle SMS verification if implementing phone backup
</script>
{% endblock %}

