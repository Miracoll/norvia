{%extends "account/base.html" %}
{% load static %}

{% block title %}Deposit Gateway Details | Norvia.io{% endblock %}

{% block body_class %}page-depositgateway{% endblock %}

{% block content %}
<div class="content-body default-height">
    <div class="container-fluid">
        <!-- Row -->
        <div class="row">
            <div class="col-xl-12">
                <div class="row">
                    <div class="col-xl-12">
                        <div class="page-titles">
                            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
                                    <li class="breadcrumb-item"><a href="{% url 'deposit' %}">Deposit</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Payment Details</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="row justify-content-center">
                    <div class="col-xl-10 col-lg-12">

                        <!-- Instruction Header -->
                        <div class="instruction-header">
                            <div class="amount-display">SEND ${{deposit.grand_total}}</div>
                            <div class="payment-method-info">
                                <i class="material-icons">account_balance</i>
                                <span>VIA {{deposit.gateway.name|upper}}</span>
                            </div>
                            <div class="instruction-text">
                                FOLLOW THE INSTRUCTIONS BELOW TO COMPLETE YOUR PAYMENT
                            </div>
                        </div>

                        <!-- Warning Card -->
                        <div class="warning-card">
                            <p>
                                Please make payment to the <span class="highlight">exact account details</span> shown
                                below.<br>
                                Any discrepancy in payment details may result in delayed processing.
                            </p>
                        </div>

                        <!-- Payment Details Container -->
                        <div class="payment-details-container">

                            <!-- PayPal Email -->
                            <div class="payment-info-section">
                                <div class="payment-info-label">Email Address</div>
                                <div class="payment-info-display large" id="paypalEmail">
                                    {{deposit.gateway.email}}
                                </div>
                                <button class="copy-button" onclick="copyInfo('paypalEmail')">
                                    <i class="material-icons">content_copy</i>
                                    Copy Email Address
                                </button>
                            </div>

                            <!-- Amount to Send -->
                            <div class="payment-info-section">
                                <div class="payment-info-label">Amount to Send</div>
                                <div class="payment-info-display large">
                                    ${{deposit.grand_total}} USD
                                </div>
                            </div>

                            <!-- Reference/Note -->
                            <div class="payment-info-section">
                                <div class="payment-info-label">Payment Reference (Include in Note)</div>
                                <div class="payment-info-display" id="paymentReference">
                                    TXN{{deposit.transaction_no}}
                                </div>
                                <button class="copy-button" onclick="copyInfo('paymentReference')">
                                    <i class="material-icons">content_copy</i>
                                    Copy Reference
                                </button>
                            </div>

                            <!-- Transaction Info -->
                            <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e5e7eb;">
                                <div class="transaction-info-row">
                                    <span class="info-label">Transaction ID</span>
                                    <span class="info-value">#TXN{{deposit.transaction_no}}</span>
                                </div>
                                <div class="transaction-info-row">
                                    <span class="info-label">Deposit To</span>
                                    <span class="info-value">Trading Wallet</span>
                                </div>
                                <div class="transaction-info-row">
                                    <span class="info-label">Payment Method</span>
                                    <span class="info-value">{{deposit.gateway.name}}</span>
                                </div>
                                <div class="transaction-info-row">
                                    <span class="info-label">Gateway Fee</span>
                                    <span class="info-value">${{deposit.gateway.transaction_fee}}</span>
                                </div>
                                <div class="transaction-info-row">
                                    <span class="info-label"><strong>Total Amount</strong></span>
                                    <span class="info-value"
                                        style="color: var(--primary); font-size: 18px;"><strong>${{deposit.grand_total}}</strong></span>
                                </div>
                            </div>

                        </div>

                        <!-- Admin Tag Message -->
                        <div class="admin-tag-message">
                            <p>
                                <strong>Important:</strong> After completing the payment, please click "I've Made
                                Payment" button below. Our team will verify your payment and credit your account within
                                1-24 hours.
                            </p>
                        </div>

                        <!-- Steps Card -->
                        <div class="steps-card">
                            <h6>
                                <i class="material-icons">lightbulb</i>
                                How to Complete Your Payment
                            </h6>
                            <div class="step-item">
                                <div class="step-number">1</div>
                                <div class="step-text">Log into your PayPal account or payment app</div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">2</div>
                                <div class="step-text">Send exactly ${{deposit.grand_total}} USD to the email address
                                    shown above</div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">3</div>
                                <div class="step-text">Include the payment reference ({{deposit.transaction_no}}) in the
                                    payment note/message</div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">4</div>
                                <div class="step-text">Complete the payment and take a screenshot for your records</div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">5</div>
                                <div class="step-text">Click "I've Made Payment" button below after completing the
                                    transaction</div>
                            </div>
                            <div class="step-item">
                                <div class="step-number">6</div>
                                <div class="step-text">Wait for admin verification - your account will be credited
                                    within 1-24 hours</div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <form action="" method="post">
                            {% csrf_token %}
                            <div class="action-buttons">
                                <button class="btn btn-outline-danger" type="submit" name="cancel">
                                    <i class="material-icons">cancel</i>
                                    Cancel Transaction
                                </button>
                                <button class="btn btn-primary" type="submit" name="pay">
                                    <i class="material-icons">check_circle</i>
                                    I've Made Payment
                                </button>
                            </div>
                        </form>

                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
    // Copy payment information function
    function copyInfo(elementId) {
        const info = document.getElementById(elementId).textContent.trim();

        navigator.clipboard.writeText(info).then(function () {
            // Find the button that was clicked
            const element = document.getElementById(elementId);
            const btn = element.nextElementSibling;

            if (btn && btn.classList.contains('copy-button')) {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="material-icons">check</i>Copied!';
                btn.style.background = '#10b981';

                setTimeout(function () {
                    btn.innerHTML = originalHTML;
                    btn.style.background = '';
                }, 2000);
            }
        }).catch(function (err) {
            alert('Failed to copy. Please copy manually.');
        });
    }

    // TODO: Django backend will handle:
    // - Pass transaction details via template context
    // - Get payment gateway details from admin settings (PayPal email, etc.)
    // - Generate unique payment reference for tracking
    // - Store transaction in database with "Pending Payment" status
    // - Admin manually verifies payment and updates status
    // - Send notifications to user when payment is verified
    // - Credit user wallet after admin confirmation
    // - Cancel button should POST to Django backend
    // - "I've Made Payment" button should POST to Django backend to mark as pending verification
</script>
{% endblock %}